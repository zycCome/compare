# ① 新增指标（Plaintext 原型）

> 指标库管理两类：**原子指标**（映射单字段，可选聚合）与**计算指标**（引用指标/函数/常量）。新增指标时完成与数据集字段的绑定。

```
[页头]
┌──────────────────────────────────────────────┐
│ 新增指标 Indicator · 新建/编辑   [保存] [校验] [发布] │
└──────────────────────────────────────────────┘

(1) 基本信息
- 指标名称 *            [协议价] / [最低价] / [差异率]
- 指标编码 *            [ind_agreement_price]
- 指标类型 *            (● 原子指标 / ○ 计算指标)
- 业务口径说明          [______________________________________]
- 单位/精度             [CNY] / [2]
- 展示格式               [number / percent / currency]（按需要）

(2) 数据集字段绑定（原子指标必填；计算指标用于“字段映射提示/血缘”）
- 选择可用数据集（可多选）   [ + 添加映射 ]
  映射1：
    数据集 *            [集团采购协议数据集 ▼]
    字段 *              [agreement_price ▼]
    默认聚合            [NONE / SUM / AVG / MIN / MAX]（可选）
  映射2：
    数据集               [供应商报价数据集]
    字段                 [offer_price]
    默认聚合             [NONE]

(3) 计算定义（当“计算指标”时显示）
- 公式编辑器（可引用指标、常量、函数）
  例1：最低价 = MIN( ind_agreement_price )
  例2：差异率 = ( ind_agreement_price - ind_baseline_price ) / ind_baseline_price
- 依赖指标选择器（自动解析并校验依赖）
  [ind_agreement_price] [ind_baseline_price]
- 维度粒度提示：按模型/方案的维度进行 group by

(4) 适用范围（可选）
- 适用数据域/组织标签      [采购] [集团] [+]
- 可作为“基准指标”       (✓ 是 / ○ 否)

(5) 预览与校验
- 解析公式/生成伪SQL
- 校验：✓ 映射完整  ✓ 依赖存在  ✓ 单位/精度合规
- 样例试算：选择数据集 + 维度 → [预览10行]
```

### 原子指标 JSON（示例）

```json
{
  "indicatorId": "ind_agreement_price",
  "indicatorName": "协议价",
  "type": "atomic",
  "bizSpec": "合同中已约定的含税价格",
  "unit": "CNY",
  "scale": 2,
  "display": { "format": "currency" },
  "mappings": [
    { "datasetId": "ds_agreement_price", "fieldCode": "agreement_price", "defaultAgg": "NONE" },
    { "datasetId": "ds_vendor_offer", "fieldCode": "offer_price", "defaultAgg": "NONE" }
  ],
  "isBaselineEligible": true,
  "tags": ["采购", "价格"]
}
```

### 计算指标 JSON（示例 1：最低价）

```json
{
  "indicatorId": "ind_min_price",
  "indicatorName": "最低价",
  "type": "derived",
  "formula": "MIN(ind_agreement_price)",
  "dependencies": ["ind_agreement_price"],
  "unit": "CNY",
  "scale": 2,
  "display": { "format": "currency" },
  "mappings": [
    { "datasetId": "ds_agreement_price", "fieldCode": "agreement_price" }
  ],
  "isBaselineEligible": true,
  "tags": ["统计", "价格"]
}
```

### 计算指标 JSON（示例 2：差异率，含占位符）

```json
{
  "indicatorId": "ind_diff_rate",
  "indicatorName": "差异率",
  "type": "derived",
  "formula": "(ind_agreement_price - ${BASELINE}) / ${BASELINE}",
  "dependencies": ["ind_agreement_price"],
  "placeholders": ["${BASELINE}"],
  "unit": "%",
  "scale": 4,
  "display": { "format": "percent" },
  "mappings": [
    { "datasetId": "ds_agreement_price", "fieldCode": "agreement_price" }
  ],
  "isBaselineEligible": false,
  "tags": ["对比", "价格"]
}
```

> 说明：`${BASELINE}` 将在**比价方案**中被替换为实际选定的“基准指标”，执行引擎据此展开公式。

---

# ③ 指标 ↔ 数据集字段 绑定交互（Plaintext 原型）

```
[弹窗] 指标字段映射（多数据集支持）
- 指标：协议价（ind_agreement_price）

(1) 已有关联
  ┌──────────┬────────────────┬──────────────────┬────────┐
  │ 数据集     │ 字段           │ 默认聚合           │ 操作     │
  ├──────────┼────────────────┼──────────────────┼────────┤
  │ 集团采购协议 │ agreement_price │ NONE              │ [删除]  │
  │ 供应商报价   │ offer_price     │ NONE              │ [删除]  │
  └──────────┴────────────────┴──────────────────┴────────┘

(2) 新增映射
  - 选择数据集 *   [▼]
  - 选择字段   *   [▼]
  - 默认聚合       [NONE/SUM/AVG/MIN/MAX]
  [ 添加 ]  [ 取消 ]

(3) 校验规则
  - 同一数据集不得重复映射同一字段
  - 原子指标可允许不同数据集各有字段映射（用于跨数据集同口径）
  - 计算指标只做“字段存在性提示”，真实取值按公式依赖解析
```

### 映射 JSON（可复用的统一结构）

```json
{
  "indicatorId": "ind_agreement_price",
  "mappings": [
    { "datasetId": "ds_agreement_price", "fieldCode": "agreement_price", "defaultAgg": "NONE" },
    { "datasetId": "ds_vendor_offer", "fieldCode": "offer_price", "defaultAgg": "NONE" }
  ],
  "validation": {
    "noDuplicate": true,
    "fieldsExist": true
  }
}
```

---