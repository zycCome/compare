# 1) Plaintext 原型（最终）

```
页头
────────────────────────────────
比价模型 · 新建/编辑
状态：草稿 | 保存 | 预览 | 发布 | 返回
────────────────────────────────

分步导航
(1) 基本信息 → (2) 数据源绑定 → (3) 对象与维度 → (4) 指标与基准 → (5) 显示属性 → (6) 预览与校验

────────────────────────────────
(1) 基本信息
- 模型名称*        [____________________________]
- 模型编码*        [mdl_vendor_compare]
- 标签            [同品多商] [历史对比] [+]
- 描述            [________________________________________________________]
- 启用            (✓)

提示：模型定义结构与标准，计算公式与基准选择将在“比价方案”里配置。

────────────────────────────────
(2) 数据源绑定（主数据集 + 附加数据集 + 对齐关系）
- 主数据集*          [ ds_agreement_price (别名 a) ▼ ]
- 附加数据集（可多） [ + 添加 ]
   已选：
   · ds_po_hist     (别名 h)
   · ds_market      (别名 m)
   · ds_bid         (别名 b)
- 对齐关系（按“主数据集 a”与每个附加数据集分别配置）
  [ + 新增对齐 ]
   · 目标数据集*     [ h | m | b ▼ ]
   · 连接类型*       [ LEFT JOIN ▼ ]
   · ON 条件*        [ a.item_id = h.item_id AND a.spec = h.spec AND a.brand = h.brand ]
   · 粒度校验        [ 检测 h 对齐键是否唯一 ✓ ]
  [ + 新增对齐 ]
   · 目标数据集*     [ m ▼ ]
   · 连接类型*       [ LEFT JOIN ▼ ]
   · ON 条件*        [ a.item_id = m.item_id AND a.brand = m.brand ]

- 字段语义映射（显示为选择器：数据集字段 → 业务语义）
  主数据集 a：
   · vendor_id → 供应商ID
   · item_id   → 商品ID
   · price     → 协议价
   · purchase_org → 采购组织
   · trade_date   → 交易日期
  提示：映射仅用于界面透出与可读性，不影响实际 SQL。

- 条件继承（可选）
  [✓] 将主数据集的“时间/组织”等筛选映射到附加数据集
     · a.trade_date → h.tx_date, m.tx_date, b.publish_date
     · a.org_id     → h.org_id,   m.org_id,   b.org_id

────────────────────────────────
(3) 对象与维度（决定归并口径与分析切分）
- 比价对象键*（同品归并口径 / compare_key）
  [ item_id ] [ spec ] [ brand ]  [+ 自定义字段]
  说明：决定“同一商品”的界定与横向对比口径，贯穿主/附加 JOIN 与展示。

- 分析对象（单选）
  (o) 供应商  ( ) 品牌  ( ) 采购组织  ( ) 其他…
  说明：用于横向对比的主维度（例如“同品多商”=供应商）。

- 分析维度（多选；用于 GROUP BY 分组层级）
  [ 供应商 ] [ 采购组织 ] [ 品牌 ] [ 月份 ] [ 地区 ] [ + 自定义 ]
  维度来源：均从(2)已绑定数据集字段中挑选（支持主/附加字段，但需能与 compare_key 关联）。

────────────────────────────────
(4) 指标与基准（仅做“可用项”的声明）
- 分析指标（来自指标库，且必须绑定主数据集 a）
  [ + 从指标库选择 ]
   · 指标库ID*     [ lib.agr_price ]     名称* [ 协议价 ]
   · 绑定数据集*   [ a（ds_agreement_price）]
   · 单位/聚合     [ 只读：来自指标库 ]

  [ + 从指标库选择 ]
   · 指标库ID*     [ lib.tax_incl_price ] 名称* [ 含税价 ]
   · 绑定数据集*   [ a ]
   · 单位/聚合     [ 只读 ]

  说明：这里仅声明方案可用的“对比侧”指标；“差异率/差额”等公式在“比价方案”定义。

- 基准候选（来自指标库，且必须绑定附加数据集 h/m/b…）
  [ + 选择基准候选 ]
   · 指标库ID*     [ lib.hist_min ]     名称* [ 历史最低价 ]
   · 绑定数据集*   [ h（ds_po_hist） ]
   · 单位/聚合     [ 只读：来自指标库 ]

  [ + 选择基准候选 ]
   · 指标库ID*     [ lib.market_ref ]   名称* [ 市场参考价 ]
   · 绑定数据集*   [ m（ds_market） ]
   · 单位/聚合     [ 只读 ]

  [ + 选择基准候选 ]
   · 指标库ID*     [ lib.bid_min ]      名称* [ 中标最低价 ]
   · 绑定数据集*   [ b（ds_bid） ]
   · 单位/聚合     [ 只读 ]

────────────────────────────────
(5) 显示属性（Display Attributes｜不进 GROUP BY）
- 用于报表展示时的加字段，挂载到“对象粒度（attachToKey）”
  [ + 新增属性 ]
   · 显示名*        [ 协议编号 ]
   · 数据集*        [ a ]
   · 字段*          [ contract_no ▼ ]
   · 绑定到对象*    [ compare_key + vendor_id ]
   · 去重策略        [ 最新记录（trade_date DESC）]

  [ + 新增属性 ]
   · 显示名*        [ 协议名称 ]
   · 数据集*        [ a ]
   · 字段*          [ contract_name ▼ ]
   · 绑定到对象*    [ compare_key + vendor_id ]
   · 去重策略        [ 最新记录 ]

说明：显示属性只做附加列，不参与聚合与计算，不改变汇总粒度。

────────────────────────────────
(6) 预览与校验
- SQL 预览（按当前模型配置）
- 粒度校验：附加数据集对齐键是否唯一、条件继承是否落地
- 指标可用性校验：分析指标是否来自 a、基准候选是否绑定 h/m/b
- 保存 / 发布
```

---

# 2) UI 原型（分步草图）

```
┌───────────────────────────────┐
│ 步骤条：①基本 → ②数据源 → ③对象维度 → ④指标基准 → ⑤显示属性 → ⑥预览 │
├───────────────────────────────┤

② 数据源绑定
  主数据集： [ ds_agreement_price (a) ▼ ]
  附加数据集： [ + 添加 ]   已选： h=ds_po_hist  m=ds_market  b=ds_bid

  对齐关系（逐个目标配置）
  [ + 新增对齐 ]
   目标数据集 [ h ▼ ]  连接[ LEFT ▼ ]
   ON： a.item_id = h.item_id AND a.spec = h.spec AND a.brand = h.brand
   [检测唯一性] ✓

  条件继承（可选）
   [✓] a.trade_date → h.tx_date, m.tx_date, b.publish_date
   [✓] a.org_id     → h.org_id,   m.org_id,   b.org_id

③ 对象与维度
  比价对象键： [ item_id ] [ spec ] [ brand ] [+]
  分析对象(单选)： (o) 供应商  ( ) 品牌  ( ) 采购组织…
  分析维度(多选)： [ 供应商 ] [ 采购组织 ] [ 月份 ] [ 地区 ] [ + ]

④ 指标与基准
  分析指标（来自指标库，绑定 a）
   [ + 从指标库选择 ] → 仅允许绑定 a
  基准候选（来自指标库，绑定 h/m/b…）
   [ + 选择基准候选 ] → 仅允许绑定 h/m/b 等附加表

⑤ 显示属性（不进 GROUP BY）
   [ + 新增属性 ] 名称/表/字段/绑定到对象/去重策略

⑥ 预览与校验
   [生成 SQL] [运行样例] [校验通过 ✓]  [保存]  [发布]
└───────────────────────────────┘
```

---

# 3) 界面配置 JSON（最终版示例）

```json
{
  "modelName": "通用同品多商比价模型",
  "modelCode": "mdl_vendor_compare",
  "tags": ["同品多商", "历史对比"],
  "enabled": true,
  "description": "以协议价为对比，提供历史/市场/中标的基准候选；在方案层定义计算公式。",

  "datasets": {
    "primary": { "id": "ds_agreement_price", "alias": "a", "name": "协议价数据集" },
    "attached": [
      { "id": "ds_po_hist",  "alias": "h", "name": "历史采购数据集" },
      { "id": "ds_market",   "alias": "m", "name": "市场行情数据集" },
      { "id": "ds_bid",      "alias": "b", "name": "招采中标数据集" }
    ],
    "joins": [
      {
        "targetAlias": "h",
        "type": "LEFT",
        "on": "a.item_id = h.item_id AND a.spec = h.spec AND a.brand = h.brand",
        "uniqueCheck": true
      },
      {
        "targetAlias": "m",
        "type": "LEFT",
        "on": "a.item_id = m.item_id AND a.brand = m.brand",
        "uniqueCheck": true
      },
      {
        "targetAlias": "b",
        "type": "LEFT",
        "on": "a.item_id = b.item_id AND a.spec = b.spec",
        "uniqueCheck": true
      }
    ],
    "fieldMapping": {
      "a.vendor_id": "供应商ID",
      "a.item_id": "商品ID",
      "a.price": "协议价",
      "a.trade_date": "交易日期",
      "a.purchase_org": "采购组织"
    },
    "conditionInheritance": [
      { "from": "a.trade_date", "to": ["h.tx_date", "m.tx_date", "b.publish_date"] },
      { "from": "a.org_id",     "to": ["h.org_id",  "m.org_id",  "b.org_id"] }
    ]
  },

  "objectAndDimensions": {
    "compareKey": ["a.item_id", "a.spec", "a.brand"],
    "analysisTarget": "供应商",
    "analysisDimensions": ["a.vendor_id", "a.purchase_org", "a.trade_month"]
  },

  "indicators": {
    "analysisIndicators": [
      {
        "libId": "lib.agr_price",
        "name": "协议价",
        "datasetAlias": "a",
        "unit": "CNY",
        "aggregation": "NONE"
      },
      {
        "libId": "lib.tax_incl_price",
        "name": "含税价",
        "datasetAlias": "a",
        "unit": "CNY",
        "aggregation": "NONE"
      }
    ]
  },

  "baselineCandidates": [
    {
      "libId": "lib.hist_min",
      "name": "历史最低价",
      "datasetAlias": "h",
      "unit": "CNY",
      "aggregation": "MIN"
    },
    {
      "libId": "lib.market_ref",
      "name": "市场参考价",
      "datasetAlias": "m",
      "unit": "CNY",
      "aggregation": "AVG"
    },
    {
      "libId": "lib.bid_min",
      "name": "中标最低价",
      "datasetAlias": "b",
      "unit": "CNY",
      "aggregation": "MIN"
    }
  ],

  "displayAttributes": [
    {
      "name": "协议编号",
      "datasetAlias": "a",
      "field": "contract_no",
      "attachTo": ["compare_key", "a.vendor_id"],
      "dedupe": { "type": "latest", "orderBy": "a.trade_date DESC" }
    },
    {
      "name": "协议名称",
      "datasetAlias": "a",
      "field": "contract_name",
      "attachTo": ["compare_key", "a.vendor_id"],
      "dedupe": { "type": "latest" }
    }
  ],

  "validationRules": {
    "analysisMustBindPrimary": true,
    "baselineMustBindAttached": true,
    "compareKeyMustResolvable": true,
    "displayAttrMustAttachToKey": true
  }
}
```

---

## 小结（这版能落地的关键）

* **JOIN 逐个目标配置**（a→h/m/b），并带**唯一性校验**；
* **分析指标**全部来自**指标库**且**绑定 a**；
* **基准候选**来自**指标库**且**绑定 h/m/b**；
* **显示属性**通过 `attachTo` 挂载到**对象粒度**，不参与聚合；
* **计算公式**与**具体基准绑定**留到**比价方案**做（这能支持多基准并列、不同条件、不同权重/规则）。


基准/对比/附加维度/附加指标
