没问题—我按“单选比价数据集 + 多选基准数据集”的逻辑，给你一份**完整的比价模型表单**：

---

# 比价模型表单（Plaintext 草图）

```
[页头]
┌──────────────────────────────────────────────────────┐
│ 比价模型 · 新建/编辑   状态: 草稿 | 保存 | 预览 | 发布 | 返回 │
└──────────────────────────────────────────────────────┘

(1) 基本信息
- 模型名称 *            [__________________________]
- 模型编码 *            [mdl_vendor_price_compare]
- 场景标签              [ 同品多商 ] [ 历史对比 ] [+]
- 描述                  [__________________________________________]
- 启用状态              (○ 停用 / ● 启用)

──────────────────────────────────────────────────────
(2) 数据绑定
2.1 选择比价数据集（单选，主角：从这里取“被比较”的指标）
    ( ) 历史采购订单数据集
    (●) 集团采购协议数据集
    ( ) 招采平台报价数据集
    ( ) 市场行情价数据集

2.2 选择基准数据集（可多选，参照物：从这里取“基准”指标）
    [✓] 历史采购订单数据集
    [✓] 市场行情价数据集
    [ ] 招采平台报价数据集

备注：后续“可选指标”会按上述选择自动过滤（只显示可取数的指标）

──────────────────────────────────────────────────────
(3) 对象与维度配置
3.1 比价对象（定义“按什么实体比较”）*
    - 对象字段（主数据集）: [ product_id | 产品ID ]  或  [ vendor_id | 供应商ID ]
3.2 分析对象（定义“谁作为分组/对照”）*
    - 对象字段: [ purchase_org | 采购组织 ]
3.3 分析维度（可多选）
    [✓] brand | 品牌     [✓] spec_model | 规格型号
    [ ] reg_level | 注册证等级   [✓] purchase_mode | 采购模式
3.4 基准维度（用于基准指标的聚合/分组，默认继承分析维度；可覆盖）
    - 选择： [同分析维度]  或  [自定义…] → [ brand, purchase_org ]

──────────────────────────────────────────────────────
(4) 指标配置
4.1 分析指标（来自指标库，必须映射到“比价数据集”）
    [✓] ind_agreement_price | 协议价（agreement_price）
    [ ] ind_trade_avg_price | 平均成交价（avg_trade_price）
    [ ] ind_trade_min_price | 最低成交价（min_trade_price）

4.2 基准指标候选（来自指标库，必须映射到“基准数据集”之一，可多选）
    [✓] ind_history_min_price | 历史最低价（min(price)）
    [✓] ind_market_ref_price | 市场参考价（avg(price)）
    [ ] ind_tender_win_price | 招采中标价（win_price）

（说明：真正使用哪一个基准指标，在“比价方案”中再单选）

4.3 计算指标（可选；模型级复用）
    [+ 新增计算指标]
      - 指标名称：差异率（agreement_vs_baseline_rate）
      - 公式： (ind_agreement_price - ${BASELINE}) / ${BASELINE}
      - 输出小数位：2

──────────────────────────────────────────────────────
(5) 字段角色标记（辅助信息统一在模型中标记）
  - 产品名称字段（主数据集）： [ product_name ]
  - 供应商名称字段（主数据集）： [ vendor_name ]
  - 辅助属性： [ reg_level | 注册证等级 ]  [ purchase_mode | 采购模式 ]

──────────────────────────────────────────────────────
(6) 输出字段配置（设置报表默认列，方案可覆写）
  - 维度列： [ 采购组织 ] [ 品牌 ] [ 规格型号 ]
  - 指标列： [ 协议价 ] [ 历史最低价 ] [ 市场参考价 ] [ 差异率 ]
  - 排序：   [ 差异率 | desc ]，次序 [ 协议价 | asc ]

──────────────────────────────────────────────────────
(7) 校验与预览
  - 校验：
      ✓ 所选指标均可在对应数据集取数
      ✓ 基准维度与分析维度可匹配
  - 预览：按“比价对象 × 分析对象 × 维度 × 指标”生成样表
```

---

# 比价模型表单（JSON 配置）

## A. 表单实例（可直接落库/调试）

```json
{
  "model_name": "同品多商价格对比模型",
  "model_code": "mdl_vendor_price_compare",
  "tags": ["同品多商", "历史对比"],
  "description": "在相同产品下，对不同供应商的协议价与多个基准指标进行对比分析",
  "status": "enabled",

  "binding": {
    "main_dataset": { "id": "ds_agreement_price", "name": "集团采购协议数据集" },
    "baseline_datasets": [
      { "id": "ds_history_order", "name": "历史采购订单数据集" },
      { "id": "ds_market_price", "name": "市场行情价数据集" }
    ]
  },

  "objects_dims": {
    "compare_object": { "field_code": "product_id", "field_name": "产品ID", "dataset_id": "ds_agreement_price" },
    "analysis_object": { "field_code": "purchase_org", "field_name": "采购组织" },
    "analysis_dimensions": [
      { "field_code": "brand", "field_name": "品牌" },
      { "field_code": "spec_model", "field_name": "规格型号" },
      { "field_code": "purchase_mode", "field_name": "采购模式" }
    ],
    "baseline_dimensions_mode": "inherit", 
    "baseline_dimensions": []
  },

  "indicators": {
    "analysis_indicators": [
      { "id": "ind_agreement_price", "name": "协议价", "dataset_id": "ds_agreement_price" }
    ],
    "baseline_candidates": [
      { "id": "ind_history_min_price", "name": "历史最低价", "dataset_id": "ds_history_order" },
      { "id": "ind_market_ref_price", "name": "市场参考价", "dataset_id": "ds_market_price" }
    ],
    "calculated_indicators": [
      {
        "id": "calc_diff_rate",
        "name": "差异率",
        "formula": "(ind_agreement_price - ${BASELINE}) / ${BASELINE}",
        "scale": 4,
        "format": "percent"
      }
    ]
  },

  "field_roles": {
    "product_name": { "field_code": "product_name", "dataset_id": "ds_agreement_price" },
    "vendor_name": { "field_code": "vendor_name", "dataset_id": "ds_agreement_price" },
    "aux_attrs": [
      { "field_code": "reg_level", "field_name": "注册证等级" },
      { "field_code": "purchase_mode", "field_name": "采购模式" }
    ]
  },

  "output": {
    "default_dimensions": ["purchase_org", "brand", "spec_model"],
    "default_metrics": ["ind_agreement_price", "ind_history_min_price", "ind_market_ref_price", "calc_diff_rate"],
    "sort": [{ "field": "calc_diff_rate", "order": "desc" }, { "field": "ind_agreement_price", "order": "asc" }]
  },

  "validation": {
    "require_main_dataset": true,
    "check_metric_dataset_mapping": true,
    "check_baseline_candidates_nonempty": true
  }
}
```

## B. 关键校验规则（引擎侧）

```json
{
  "rules": [
    "main_dataset != null",
    "analysis_indicators[].dataset_id == main_dataset.id",
    "baseline_candidates[].dataset_id ∈ baseline_datasets[].id",
    "calculated_indicators[].formula 仅引用 已选的 analysis_indicators 与占位符 ${BASELINE}",
    "baseline_dimensions_mode == 'inherit' 或 baseline_dimensions 非空"
  ]
}
```

---

## 使用说明（和比价方案的衔接）

* **模型阶段**：

  * 固定主角（单选比价数据集）
  * 给出“基准数据集 + 候选基准指标”的集合
  * 统一定义对象、维度、字段角色、默认输出列

* **方案阶段**：

  * 从“候选基准指标”中 **单选** 一个作为本次执行的**基准**
  * 具体执行范围（组织/产品/时间）放在方案里
  * 输出列、排序可在方案里覆写

这样既保证了**数据来源约束**（可取数、可聚合），又保留了**执行灵活性**（不同方案可选不同基准）。

---
