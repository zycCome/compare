好的！我给你一套**可落地**的「评分型因子分类表 + 常用公式库」，外加**UI 原型**与**配置 JSON**，直接塞进你现在的规则编辑器就能用。

# 一、评分型因子分类表（可做“因子库”）

| 类别                             | 因子（示例）                | 含义/口径            | 单位   | 推荐权重\*    | 默认打分模板                                       |
| ------------------------------ | --------------------- | ---------------- | ---- | --------- | -------------------------------------------- |
| 价格类                            | 差异率 `diff_rate`       | (报价-基准)/基准       | %    | 0.40–0.60 | 区间：0–5%=100；5–10%=80；10–20%=60；>20%=30（单调递减） |
|                                | 差异额 `diff_amount`     | 报价-基准            | CNY  | 0.10–0.20 | 公式：`CLAMP(100 - (x/阈值)*100, 0, 100)`         |
|                                | 价格波动率 `price_vol`     | (近N期max-min)/min | %    | 0.05–0.10 | 公式（递减）：`CLAMP(100 - k*x, 0, 100)`            |
| 历史表现                           | 历史中标率 `win_rate`      | 中标次数/参与次数        | %    | 0.05–0.10 | 区间：≥60%=100；40–60=80；20–40=60；<20=40         |
|                                | 履约完成率 `fulfill_rate`  | 按期交付数量/应交付       | %    | 0.05–0.10 | 区间：≥95%=100；90–95=90；80–90=70；<80=50         |
| 供货能力                           | 交付周期 `lead_time`      | 平均交付天数           | 天    | 0.05–0.10 | 公式（越短越高）：`SCALE_INV(x, min,max)`             |
|                                | 库存覆盖天数 `stock_cover`  | 可用库存/日均需求        | 天    | 0.02–0.05 | 区间：≥30=100；20–30=90；10–20=70；<10=50          |
| 质量合规                           | 投诉率 `complaint_rate`  | 投诉数/成交数          | ‰/万笔 | 0.02–0.05 | 公式（递减）：`CLAMP(100 - k*x, 0, 100)`            |
| 品牌与认可                          | 供应商评级 `vendor_rating` | 外部/内部评审分         | 分    | 0.05–0.15 | 直取：`CLAMP(x,0,100)`                          |
| \*权重建议是默认区间，实际在规则里可调，并支持自动归一化。 |                       |                  |      |           |                                              |

> 注意：**合规硬性项**（注册证有效、黑名单等）建议走**控制型**，不合格先剔除，再进评分。

---

# 二、常用公式库（可在编辑器里一键插入）

| 模板名       | 公式（以 x 表示该因子原始值）                 | 适用场景            | 备注           |
| --------- | -------------------------------- | --------------- | ------------ |
| 差异率\_线性扣分 | `CLAMP(100 - x*1000, 0, 100)`    | 差异率（单位小数，如0.08） | 10%掉到0分；系数可调 |
| 差异率\_分段台阶 | 见区间模板                            | 同上              | 更易解释         |
| 差异额\_阈值折算 | `CLAMP(100 - (x/T)*100, 0, 100)` | 与预算/阈值T对比       | 传入 T         |
| 递减线性      | `CLAMP(100 - k*x, 0, 100)`       | 投诉率、波动率、周期      | k 由业务调参      |
| 递增线性      | `CLAMP(a*x + b, 0, 100)`         | 履约完成率           | a,b 拟合       |
| 反向归一      | `SCALE_INV(x, min, max)`         | 周期越短越好          | 返回0–100      |
| 归一到0–100  | `SCALE(x, min, max)`             | 值越大越好           | 返回0–100      |
| 百分比化      | `PCT(x)`                         | 0–1 → 0–100     |              |
| 截断        | `CLAMP(x, lo, hi)`               | 任意              |              |
| Z分数       | `Z_SCORE(x, μ, σ)`               | 标准化             | 后接线性映射       |

**区间模板（示例，自动生成表格）**

* 差异率（单调递减）：
  `[0,0.05)→100；[0.05,0.10)→80；[0.10,0.20)→60；[0.20,1]→30`
* 履约完成率（单调递增）：
  `[0.95,1]→100；[0.90,0.95)→90；[0.80,0.90)→70；[0,0.80)→50`

---

# 三、评分编辑 UI 原型（嵌入你现有弹窗）

## plaintext（因子弹窗）

```
[新增评分因子]
指标选择*     [ 从模型指标选择 ▼ ]  (支持搜索/分组：原子/计算)
权重*         [  50% ──────────●──────────  ] (数字输入: 50)
缺失值策略    [ 跳过并归一 | 按0分 | 按自定义分(输入框) ]

打分模式*     (●) 区间打分   ( ) 公式打分
— 区间打分 —
[+ 从分位点生成 ▼]  [单调递减 ✓]  [覆盖/重叠校验 ✓]
表格：下界 | 上界 | 区间符号([,( ]) | 分值(0-100) | 操作

— 公式打分 —
表达式         [  100 - (x*1000)                       ]
函数库         [ CLAMP ] [ SCALE ] [ SCALE_INV ] [ PCT ] [...]
裁剪           [ 0–100 裁剪 ✓ ]
曲线预览       (mini chart, x∈[min,max])

[ 取消 ] [ 确定 ]
```

## 评分列表（规则页）

* 表格列：**因子** | **权重** | **模式** | **预览** | **缺失策略** | 操作
* 顶部：权重合计显示 & 「自动归一化」开关（开：保存时归一）

---

# 四、执行后的输出（供方案/报表使用）

**规则引擎产出列（建议约定）**

* `score`（0–100）：加权总分
* `score_breakdown`（JSON）：每个因子的原值、得分、权重、模式

  ```json
  [
    {"factor":"diff_rate","raw":0.12,"mode":"range","score":60,"weight":0.6},
    {"factor":"vendor_rating","raw":85,"mode":"raw","score":85,"weight":0.4}
  ]
  ```
* 可选：单因子列 `score_diff_rate` / `score_vendor_rating`（便于排序/筛选）

**表格展现**

* “总分”列显示条形+数值；hover 展示 `score_breakdown`
* 侧栏“评分解释”展开每因子的命中区间或公式值、权重、贡献
* 顶部摘要：均值、分布图、TOP/BOTTOM 列表

---

# 五、配置 JSON（因子库 & 规则使用）

## A. 因子库（可维护为一个静态/可管理资源）

```json
{
  "factorLibraryVersion": "v1.0",
  "factors": [
    {
      "id": "diff_rate",
      "name": "差异率",
      "category": "price",
      "unit": "percent",
      "defaultWeight": 0.5,
      "defaultMode": "range",
      "defaultRanges": [
        {"l":0.00,"lc":"[","r":0.05,"rc":")","score":100},
        {"l":0.05,"lc":"[","r":0.10,"rc":")","score":80},
        {"l":0.10,"lc":"[","r":0.20,"rc":")","score":60},
        {"l":0.20,"lc":"[","r":1.00,"rc":"]","score":30}
      ]
    },
    {
      "id": "diff_amount",
      "name": "差异额",
      "category": "price",
      "unit": "CNY",
      "defaultWeight": 0.15,
      "defaultMode": "formula",
      "defaultExpr": "CLAMP(100 - (x/T)*100, 0, 100)",
      "params": {"T": 5000}
    },
    {
      "id": "vendor_rating",
      "name": "供应商评级",
      "category": "brand",
      "unit": "score",
      "defaultWeight": 0.35,
      "defaultMode": "formula",
      "defaultExpr": "CLAMP(x,0,100)"
    }
  ],
  "functionLibrary": ["CLAMP","SCALE","SCALE_INV","PCT","Z_SCORE"]
}
```

## B. 规则中使用（评分型）

```json
{
  "ruleId": "rule_vendor_score",
  "modelRef": "mdl_vendor_price_compare",
  "type": "score",
  "aggregate": "weighted_sum",
  "autoNormalizeWeight": true,
  "factors": [
    {
      "fromLibrary": "diff_rate",
      "indicatorId": "ind_diff_rate_b1",  // 与模型列对齐
      "weight": 0.6,
      "mode": "range",
      "ranges": "useDefault",
      "onNull": "skip"
    },
    {
      "fromLibrary": "vendor_rating",
      "indicatorId": "vendor_rating",
      "weight": 0.4,
      "mode": "formula",
      "expr": "CLAMP(x,0,100)",
      "onNull": "zero"
    }
  ]
}
```

> 说明：`fromLibrary` 用于快速带出默认权重/模板，实际保存时会把最终值写进规则，保证“所见即所得”。

---

# 六、落地建议

* **先上“因子库 + 公式库”**：让90%的用户不写公式，直接选模板；高级用户再切到表达式。
* **强校验**：区间覆盖/重叠、单调性（可开关）、权重和为1（自动归一）。
* **可解释性**：务必保留 `score_breakdown`，这会极大降低争议。

