# 一、比价方案 UI 草图（Plaintext 原型）

```
[页头]
┌─────────────────────────────────────────────────────────────┐
│ 比价方案 · 新建/编辑                          状态: 草稿  ⓘ │
│ [返回]                                           [保存] [发布] │
└─────────────────────────────────────────────────────────────┘

(1) 基本信息
┌─────────────────────────────────────────────────────────────┐
│ 方案名称 *         [ 同品多商-协议价对比多基准_2024Q1           ] │
│ 方案编码 *         [ cmp_vendor_multi_baseline_2024Q1          ] │
│ 标签               [集团采购] [价格监控] [+]                    │
│ 描述               [________________________________________] │
│ 启用               (o) 启用   ( ) 停用                          │
└─────────────────────────────────────────────────────────────┘

(2) 绑定比价模型 *
┌─────────────────────────────────────────────────────────────┐
│ [ 通用供应商比价模型 ▼ ]   [查看模型摘要]                     │
│ 模型摘要（只读）：                                           │
│ · 主数据集: ds_agreement_price  · compare keys: item_id,brand │
│ · 分析对象: 供应商         · 维度: 供应商/组织/时间(月)       │
│ · 可用/原子指标: ind_agreement_price...                      │
│ · 可用基准候选: ds_bid[ind_bid_min], ds_po_hist[ind_hist_min] │
│ · 默认输出: 供应商, 协议价, ${BASELINE}, 差异率               │
└─────────────────────────────────────────────────────────────┘

(3) 执行范围（WHERE 条件）
┌─────────────────────────────────────────────────────────────┐
│ 组织范围       [ 集团 ] [ 子公司A ] [ + ] (支持树勾选)         │
│ 商品范围       分类[ IVD试剂 ▼ ]   品牌[ Roche ▼ ]             │
│ SKU/清单导入   [ 选择文件… ]   [ 查看清单 ]                    │
│ 时间范围 *     [ 2024-01-01  ~  2024-03-31 ]（按模型时间字段）  │
│ 供应商（可选） [ 多选下拉/搜索 ]                               │
└─────────────────────────────────────────────────────────────┘

(4) 多基准设置（可添加多个“基准块”）
┌─────────────────────────────────────────────────────────────┐
│ [ + 添加基准块 ]                                             │
│                                                             │
│ 基准块 #1                                                    │
│ ─────────────────────────────────────────────────────────── │
│ 参与侧指标 *      [ ind_agreement_price ▼ ]                  │
│ 基准数据集 *      [ ds_bid ▼ ]                               │
│ 基准指标 *        [ ind_bid_min ▼ ]                          │
│ 占位符绑定        ${BASELINE} ← [ ind_bid_min ]              │
│ 对齐维度策略      (o) 继承模型   ( ) 自定义                   │
│  · 自定义维度(当选中自定义可见)： [ 组织 ] [ 月份 ] [ 地区 ]  │
│ 结果列命名        [ baseline_price_A ] [ diff_rate_A ]       │
│ [ 复制 ] [ 删除 ]                                            │
│                                                             │
│ 基准块 #2                                                    │
│ ─────────────────────────────────────────────────────────── │
│ 参与侧指标 *      [ ind_agreement_price ▼ ]                  │
│ 基准数据集 *      [ ds_po_hist ▼ ]                           │
│ 基准指标 *        [ ind_hist_min ▼ ]                         │
│ 占位符绑定        ${BASELINE} ← [ ind_hist_min ]             │
│ 对齐维度策略      (o) 继承模型   ( ) 自定义                   │
│ 结果列命名        [ baseline_price_B ] [ diff_rate_B ]       │
│ [ 复制 ] [ 删除 ]                                            │
└─────────────────────────────────────────────────────────────┘

(5) 规则集（可选）
┌─────────────────────────────────────────────────────────────┐
│ 绑定规则集         [ rule_vendor_compare_default ▼ ]          │
│ [查看规则] 规则示例：                                        │
│ · control: diff_rate_A > 0.2 → 标红 & 邮件                    │
│ · score:   0.6*scoreA + 0.4*vendor_reputation                │
└─────────────────────────────────────────────────────────────┘

(6) 输出与排序
┌─────────────────────────────────────────────────────────────┐
│ 输出列（拖拽排序）                                           │
│ [ 供应商 ][ 采购组织 ][ 协议价 ][ baseline_price_A ][ diff_rate_A ] │
│ [ baseline_price_B ][ diff_rate_B ][ score ][ warn ]         │
│ 默认排序            [ diff_rate_A ▼ ]                        │
│ 导出格式            [ Excel □CSV □API ]                      │
└─────────────────────────────────────────────────────────────┘

(7) 预览与执行
┌─────────────────────────────────────────────────────────────┐
│ [ 生成SQL ]  [ 预览样例10行 ]  [ 执行 ]  [ 导出 ]            │
│ [ 配置调度… ] [ 仅保存不执行 ]                               │
│ SQL 校验：占位符就绪 √  对齐维度一致 √  时间口径：按月          │
└─────────────────────────────────────────────────────────────┘
```

---

# 二、比价方案（多基准）JSON Schema（draft-07）

> 这份 Schema 直接可用于 FE 表单校验 & BE 入参校验。占位符绑定、列命名、维度策略等都包含了。

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://example.com/schemas/comparison-scheme.json",
  "title": "Comparison Scheme (Multi-Baseline)",
  "type": "object",
  "required": ["schemeName", "schemeCode", "enabled", "modelRef", "scope", "baselines", "output"],
  "properties": {
    "schemeName": { "type": "string", "minLength": 1, "maxLength": 128 },
    "schemeCode": { "type": "string", "pattern": "^[a-zA-Z0-9_\\-]{1,128}$" },
    "tags": { "type": "array", "items": { "type": "string" }, "maxItems": 20 },
    "enabled": { "type": "boolean", "default": true },

    "modelRef": {
      "type": "object",
      "required": ["id"],
      "properties": {
        "id": { "type": "string" },
        "name": { "type": "string" }
      },
      "additionalProperties": false
    },

    "scope": {
      "type": "object",
      "required": ["timeRange"],
      "properties": {
        "org": { "type": "array", "items": { "type": "string" } },
        "product": {
          "type": "object",
          "properties": {
            "category": { "type": "string" },
            "brand": { "type": "string" },
            "skuList": { "type": "array", "items": { "type": "string" }, "maxItems": 10000 }
          },
          "additionalProperties": true
        },
        "vendor": { "type": "array", "items": { "type": "string" } },
        "timeRange": {
          "type": "array",
          "items": { "type": "string", "format": "date" },
          "minItems": 2,
          "maxItems": 2
        },
        "extra": { "type": "object", "additionalProperties": true }
      },
      "additionalProperties": false
    },

    "baselines": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/baselineBlock"
      },
      "maxItems": 6
    },

    "ruleSetRef": {
      "type": "object",
      "required": ["id"],
      "properties": {
        "id": { "type": "string" },
        "name": { "type": "string" }
      },
      "additionalProperties": false
    },

    "output": {
      "type": "object",
      "required": ["columns"],
      "properties": {
        "columns": { "type": "array", "items": { "type": "string" }, "minItems": 1 },
        "orderBy": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["field", "order"],
            "properties": {
              "field": { "type": "string" },
              "order": { "type": "string", "enum": ["asc", "desc"] }
            },
            "additionalProperties": false
          },
          "maxItems": 3
        },
        "export": {
          "type": "object",
          "properties": {
            "excel": { "type": "boolean", "default": true },
            "csv": { "type": "boolean", "default": false },
            "api": { "type": "boolean", "default": false }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    }
  },

  "definitions": {
    "baselineBlock": {
      "type": "object",
      "required": [
        "label",
        "participantIndicatorId",
        "datasetId",
        "indicatorId",
        "bindPlaceholders",
        "alignMode",
        "resultAlias"
      ],
      "properties": {
        "label": { "type": "string", "minLength": 1, "maxLength": 64 },
        "participantIndicatorId": { "type": "string" },
        "datasetId": { "type": "string" },
        "indicatorId": { "type": "string" },
        "bindPlaceholders": {
          "type": "object",
          "patternProperties": {
            "^\\$\\{[A-Z_][A-Z0-9_]*\\}$": { "type": "string" }
          },
          "minProperties": 1,
          "additionalProperties": false
        },
        "alignMode": {
          "type": "object",
          "required": ["mode"],
          "properties": {
            "mode": { "type": "string", "enum": ["inherit", "custom"] },
            "dimensions": { "type": "array", "items": { "type": "string" }, "maxItems": 8 }
          },
          "additionalProperties": false
        },
        "filters": {
          "type": "object",
          "description": "额外作用在基准数据集上的过滤（可选）",
          "additionalProperties": true
        },
        "resultAlias": {
          "type": "object",
          "required": ["baselineColumn", "diffRateColumn"],
          "properties": {
            "baselineColumn": { "type": "string", "pattern": "^[a-zA-Z_][a-zA-Z0-9_]{0,63}$" },
            "diffRateColumn": { "type": "string", "pattern": "^[a-zA-Z_][a-zA-Z0-9_]{0,63}$" }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    }
  },

  "additionalProperties": false
}
```

---

# 三、SQL 生成逻辑（可直接给后端实现）

## 0) 名词约定

* **主数据集** = 模型 primary dataset（参与侧）
* **基准块** = 本次方案中的某一组“参与指标 vs 基准指标”的配置
* **compare keys** = 模型定义的同类归并口径（如 item\_id, brand…）
* **baseline dimensions** = 基准对齐使用的维度（继承或自定义）

## 1) 生成步骤（算法）

1. **加载模型**（by `modelRef.id`）：拿到

   * 主数据集表名 / 字段映射（vendor\_id/item\_id/brand/price/time…）
   * compare keys / 分析对象 / 维度（用于 group by）
   * 模型指标（原子/计算）与**占位符清单**（如 `${BASELINE}`）
2. **主数据（参与侧）CTE：`P AS (...)`**

   * 从主数据集取参与指标列 + compare keys + 维度 + 范围过滤（方案.scope）
   * 做必要单位/币种统一（若模型定义了角色映射）
3. **对每个基准块** `baseline[i]`：

   * **基准聚合 CTE：`B_i AS (...)`**

     * 表 = `baseline[i].datasetId` 对应表
     * 指标 = `baseline[i].indicatorId`（通常 `MIN(bid_price)` 这类）
     * 对齐维度 = `inherit` ⇒ 使用模型 baseline 维度；`custom` ⇒ 用配置的维度列表
     * 作用基准块 filters（如限定“只看集团范围外数据集”）
   * **占位符绑定**：把模型公式里 `${BASELINE}` 替换为 `B_i.baseline_value`
   * **JOIN 规则**：`P` 与 `B_i` 使用 **compare keys + baseline维度** 做等值 JOIN
   * **派生列**：

     * `baseline[i].resultAlias.baselineColumn = B_i.baseline_value`
     * `baseline[i].resultAlias.diffRateColumn = (participant - baseline)/baseline`

       * `NULL` 保护：baseline 为 0 或 NULL 时，diffRate = NULL 或 设为 0 并标注 `warn_zero_baseline`
4. **规则集应用**：

   * 控制型：为每个规则产生 `CASE WHEN` 标志列或 `warn` 列；必要时行过滤
   * 评分型：生成 `score_*` 列并合成总分 `score`
5. **输出列与排序**：

   * 取方案 output.columns 的顺序；`ORDER BY` 方案设定
6. **导出/预警**：

   * 依据方案 output.export & rule actions 触发邮件/消息/流程

## 2) SQL 模板（示意，ClickHouse/MySQL 均易改）

> 以下以**单一时间粒度(月)**、两个基准块 A/B 为例。实际实现用字符串模板拼装。

```sql
WITH
-- P: 参与侧（主数据集）
P AS (
  SELECT
    p.item_id,
    p.brand,
    p.vendor_id,
    p.org_id,
    DATE_FORMAT(p.tx_date, '%Y-%m-01') AS month_key,
    p.agreement_price AS ind_agreement_price
  FROM ds_agreement_price p
  WHERE p.org_id IN (/* scope.org */)
    AND p.brand IN (/* scope.product.brand or list */)
    AND p.tx_date BETWEEN :start AND :end
),

-- B_A: 基准块A（招采最低价）
B_A AS (
  SELECT
    b.item_id,
    b.brand,
    DATE_FORMAT(b.bid_date, '%Y-%m-01') AS month_key,
    MIN(b.bid_price) AS baseline_value
  FROM ds_bid b
  WHERE b.bid_date BETWEEN :start AND :end
  /* 可拼接 baseline.filters */
  GROUP BY b.item_id, b.brand, DATE_FORMAT(b.bid_date, '%Y-%m-01')
),

-- B_B: 基准块B（历史最低价）
B_B AS (
  SELECT
    h.item_id,
    h.brand,
    DATE_FORMAT(h.tx_date, '%Y-%m-01') AS month_key,
    MIN(h.po_price) AS baseline_value
  FROM ds_po_hist h
  WHERE h.tx_date BETWEEN :start AND :end
  GROUP BY h.item_id, h.brand, DATE_FORMAT(h.tx_date, '%Y-%m-01')
)

SELECT
  P.vendor_id,
  P.org_id,
  P.item_id,
  P.brand,
  P.month_key,
  P.ind_agreement_price,

  -- A 结果列
  B_A.baseline_value                   AS baseline_price_A,
  CASE
    WHEN B_A.baseline_value IS NULL OR B_A.baseline_value = 0 THEN NULL
    ELSE (P.ind_agreement_price - B_A.baseline_value) / B_A.baseline_value
  END                                  AS diff_rate_A,

  -- B 结果列
  B_B.baseline_value                   AS baseline_price_B,
  CASE
    WHEN B_B.baseline_value IS NULL OR B_B.baseline_value = 0 THEN NULL
    ELSE (P.ind_agreement_price - B_B.baseline_value) / B_B.baseline_value
  END                                  AS diff_rate_B

  /* + 评分/预警列 CASE WHEN ...  */

FROM P
LEFT JOIN B_A
  ON P.item_id = B_A.item_id
 AND P.brand   = B_A.brand
 AND P.month_key = B_A.month_key
LEFT JOIN B_B
  ON P.item_id = B_B.item_id
 AND P.brand   = B_B.brand
 AND P.month_key = B_B.month_key
/* WHERE ...（若有控制型“剔除”规则） */
ORDER BY diff_rate_A DESC
LIMIT 1000;
```

### 维度策略差异

* `inherit`：`B_i` 的 `GROUP BY` 维度与 `P` 的维度一致（通常包含 compare keys + 时间）
* `custom`：显式用 `baseline[i].alignMode.dimensions` 生成 `GROUP BY` 与 `JOIN` 键；需要校验**自定义维度必须是模型可识别/映射的语义字段**

### 占位符替换（计算指标）

* 若模型计算指标为：`ind_diff_rate = ( ind_agreement_price - ${BASELINE} ) / ${BASELINE}`
* 生成时将 `${BASELINE}` 替换为 `B_i.baseline_value`（或其别名），并生成列名 `baseline[i].resultAlias.diffRateColumn`

### 单位/币种统一（可选）

* 在 `P`/`B_i` 的 CTE 内部按模型的**字段角色**做转换，例如：

  ```sql
  CASE WHEN p.currency <> 'CNY' THEN fx_rate(p.currency,'CNY',p.tx_date)*p.price ELSE p.price END AS agreement_price
  ```
* 需要在模型里声明**统一口径**，方案不再关心

## 3) 校验点（后端强校验）

* **占位符就绪**：模型公式中的占位符全部在每个基准块 `bindPlaceholders` 中有绑定
* **指标可用性**：`participantIndicatorId` 必须来自**模型指标集**；`indicatorId` 必须属于**模型基准候选**中该数据集的指标
* **维度一致性**：JOIN 键 = compare keys + baseline 维度（`inherit` 或 `custom`）；后端需给出缺失维度的错误
* **时间口径**：主/基准都能生成相同粒度的时间键（如 `month_key`）；不一致时报错或强制映射
* **零/空基准**：除零保护；可提供方案级策略：`null` / `0` / `极大值` / `行过滤`
* **列名合法性**：`resultAlias` 中的别名需通过正则校验，且避免与已有列冲突

## 4) 性能建议

* 常用基准（如历史最低）做**物化视图/周期快照**（按 compare keys + 时间维度聚好）
* 为 JOIN 键建立索引（`item_id, brand, month_key`…）
* 大范围方案分页/分片执行（按组织/月份切分）
* 结果入库（宽表）复用报表，不每次都现算

---

# 四、交付清单（你可以直接安排开发）

1. **UI 表单**按「Plaintext 草图」实现
2. **入参校验**按「JSON Schema」做（FE/BE 都可用）
3. **执行引擎**按「SQL 生成逻辑」落地：

   * 构建 `P` CTE（参与侧）
   * 循环基准块生成 `B_i` CTE + JOIN + 差异列
   * 应用规则 → 输出列与排序 → 导出/预警
4. **单测样例**：

   * 单基准 / 多基准
   * `inherit` 与 `custom` 对齐维度
   * 零/空基准保护
   * 不同时间粒度（月/季/年）

