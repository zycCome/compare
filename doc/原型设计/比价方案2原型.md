没问题！下面给你一份**完整的「比价方案2」规格**，分三块输出：

1. plaintext 原型（信息架构 + 操作步骤 + 校验要点）
2. UI 原型配置（页面结构 + 关键交互）
3. 界面配置 JSON（可直接当前后端契约样例）

> 背景前提：**计算指标前置在“比价模型”里**，方案只做选择与执行；规则引用模型指标；方案负责范围/选择/输出/调度。

---

# 一、plaintext 原型

```
[页头]
比价方案2 · 新建/编辑       状态：草稿/启用
操作：保存｜预览｜执行一次｜发布调度

[分步导航]
① 基本信息 → ② 绑定模型 → ③ 查询范围 → ④ 指标选择
→ ⑤ 规则与参数 → ⑥ 输出与样式 → ⑦ 预览与执行 → ⑧ 调度与推送（可选）

────────────────────────────────

① 基本信息
- 方案名称*        [__________________]
- 方案编码*        [cmp_XXXX_2025Q1]
- 标签            [集团采购] [价格监控] [+]
- 描述            [__________________________________]
- 启用            (✓)

② 绑定模型（只读概览）
- 选择模型*        [ mdl_vendor_price_compare ▼ ]
- 模型概览         比价对象/维度、主/基准数据集、基准别名(b1/b2/…)
- 可用指标         分组展示：原子指标 / 基准指标 / 计算指标（含 _b1/_b2 展开名）

③ 查询范围（WHERE）
- 时间范围*        [ 2025-01-01 ~ 2025-03-31 ]（字段继承模型主表时间口径）
- 组织范围         [ 树选择 ]
- 商品/品牌/SKU    [ 条件构建器 / 导入SKU清单 ]
- 供应商           [ 多选下拉 / 搜索 ]
- 其他条件         [ + 添加 ]（来自模型白名单字段；支持继承到基准）
- 校验：空基准行处理策略（保留/过滤/标记）

④ 指标选择（实例化）
- 对比侧指标*      [ 从模型“主数据集原子指标”挑选，如 协议价/含税价 ]
- 基准别名*        [ 多选：b1 / b2 / b3 … ]（决定启用哪些基准）
- 计算指标         [ 勾选要输出的计算指标（来自模型，含 *_b1/_b2 自动展开）]
- 说明：计算列由模型定义，方案只做启用与基准勾选

⑤ 规则与参数
- 选择规则集       [ 可多选：rule_price_warning / rule_vendor_score … ]
- 规则参数（可选）  [ 阈值覆写/开关，按规则包声明的可调参数 ]
- 命中后动作       [ 预警/审批/剔除 标记策略 ]

⑥ 输出与样式
- 维度列           [ 勾选：供应商、组织、品牌、月份… ]
- 指标列           [ 勾选：对比侧价、基准价_b1/_b2、计算指标、score、命中标记… ]
- 排序             [ 拖拽/设置：如 ind_diff_rate_b1 ↓，score ↓ ]
- 分组/汇总        [ 可选：按组织/品牌小计 ]
- 样式规则         [ 表达式或条件：如 ind_diff_rate_b1 > 0.10 → 标红 ]

⑦ 预览与执行
- 预览样例         取前 N 行（显示 JOIN 命中率、空基准比例）
- 规则预览         展示命中数量、评分分布
- 导出             [ Excel / CSV / API / 入库表 ]

⑧ 调度与推送（可选）
- 调度              [ 每日/每周/每月，时刻，时区 ]
- 推送              [ 邮件/企微/飞书；成功/失败/预警汇总 ]
- 落库              [ 结果目标表/分区字段 ]

────────────────────────────────
【保存时校验要点】
- 绑定模型存在且启用
- 范围字段符合模型白名单与映射
- 对比侧指标∈模型主数据原子指标
- 至少选择一个基准别名
- 勾选的计算指标在模型中存在；若选择 b1/b2，仅输出相应后缀列
- 规则集字段均可在本方案输出中产出（含 score 列）
- 空基准处理策略已选择；单位/币种一致性
```

---

# 二、UI 原型配置（结构 & 关键交互）

**整体：** 顶部固定操作区 + 左侧步骤条 + 右侧内容。右上角提供「校验结果」抽屉。

### ① 基本信息

* `TextField`：名称/编码/描述
* `Tag/Chips`：标签
* `Switch`：启用

### ② 绑定模型

* `Select`：选择模型
* 模型摘要卡片：对象键/维度/数据集/基准别名/可用指标计数
* 指标抽屉（只读）：分组列表（原子/基准/计算），可搜索

### ③ 查询范围

* 时间：`DateRangePicker`
* 组织：`TreeSelect`
* 供应商/品牌：`MultiSelect + Search`
* 其他条件：条件构建器（字段下拉→操作符→值），支持“继承到基准”
* 提示条：显示“空基准处理”选项（`RadioGroup`：保留/过滤/标记）

### ④ 指标选择

* 对比侧指标：`Select`（主数据原子指标）
* 基准别名：`CheckboxGroup`（b1/b2/b3…，显示别名说明）
* 计算指标：`Table` 勾选（从模型读）

  * 列：ID/名称/绑定模式/可用后缀（\_b1/\_b2…）/单位/说明
  * 勾选后显示将输出的**最终列名**（如 ind\_diff\_rate\_b1）

### ⑤ 规则与参数

* 规则集选择：`MultiSelect`
* 参数覆写：当规则包暴露参数时，展示 `Form`（阈值、开关等）
* 动作策略：`Select`（warn/error/exclude/mark）

### ⑥ 输出与样式

* 维度/指标双列选择器：左侧可选，右侧已选；支持拖拽排序
* 排序：`Order Builder`（field+asc/desc）
* 分组/汇总：`Switch` + 分组字段多选
* 样式规则：`Table`（表达式/颜色/图标）；快速模板按钮（>10%标红等）

### ⑦ 预览与执行

* 预览表格：50 行样例；顶部显示命中统计（JOIN 命中率、空基准率）
* 规则预览：命中计数、评分箱线图（可选）
* 导出：`ButtonGroup`（Excel/CSV/API）

### ⑧ 调度与推送

* 调度：`Cron Builder`（每日/每周/每月）+ 时间选择
* 推送：`MultiSelect`（邮件/IM）+ 收件人输入
* 入库：目标表选择、分区字段选择

**统一交互**

* 每步右上角显示“校验状态”徽标；出错项点击可定位
* 「保存」前二次校验，失败禁用保存；显示错误清单
* 「预览」会以当前范围+选择生成临时 SQL 执行

---

# 三、界面配置 JSON（契约样例）

> 说明：以下 JSON 假设已存在模型 `mdl_vendor_price_compare`，其中已定义原子/基准/计算指标（含 `_b1/_b2`）。

```json
{
  "schemeId": "cmp_vendor_vs_baseline_2025Q1",
  "schemeName": "集团Q1 协议价对比（历史/市场）",
  "enabled": true,
  "tags": ["集团采购", "价格监控"],
  "modelRef": {
    "id": "mdl_vendor_price_compare",
    "name": "供应商价格对比模型"
  },

  "scope": {
    "timeRange": ["2025-01-01", "2025-03-31"],
    "org": ["集团", "子公司A"],
    "product": { "brand": ["Roche"], "category": "IVD试剂", "skuList": null },
    "vendor": null,
    "extraFilters": [
      { "field": "a.purchase_mode", "op": "IN", "value": ["集中采购"] }
    ],
    "onMissingBaseline": "mark"   // keep=保留, filter=过滤, mark=标记
  },

  "selection": {
    "compareIndicatorId": "ind_agreement_price",   // 从模型主数据原子指标里选
    "baselineAliases": ["b1", "b2"],               // 启用哪些基准（如 b1=历史最低, b2=市场参考）
    "calculatedIndicators": [                      // 勾选的计算指标（来自模型）
      "ind_diff_amount",                           // 将物化 ind_diff_amount_b1 / _b2
      "ind_diff_rate"
    ]
  },

  "rules": {
    "ruleSetRefs": [
      { "id": "rule_price_warning", "params": { "warn_threshold_rate": 0.10 } },
      { "id": "rule_vendor_score",  "params": {} }
    ],
    "actions": { "onWarn": "notify", "onError": "block", "onExclude": "drop" }
  },

  "output": {
    "dimensions": ["vendor_id", "org_id", "brand", "ym"],
    "indicators": [
      "ind_agreement_price",
      "ind_hist_min_b1",           // 模型基准价（历史最低）按别名展开后的最终列名（可选）
      "ind_market_ref_b2",         // 若模型为基准指标注册了最终列名，可直接选择
      "ind_diff_amount_b1",
      "ind_diff_amount_b2",
      "ind_diff_rate_b1",
      "ind_diff_rate_b2",
      "score",
      "warn_flag"
    ],
    "orderBy": [
      { "field": "ind_diff_rate_b1", "order": "desc" },
      { "field": "score", "order": "desc" }
    ],
    "groupBy": ["org_id", "brand"],
    "styleRules": [
      { "expr": "ind_diff_rate_b1 > 0.10", "style": { "color": "red" } },
      { "expr": "warn_flag = true", "style": { "icon": "alert" } }
    ],
    "export": ["excel", "csv", "api"]
  },

  "schedule": {
    "enabled": true,
    "cron": "0 8 * * 1",            // 每周一 08:00
    "timezone": "Asia/Shanghai",
    "notify": {
      "channels": ["email", "wecom"],
      "recipients": ["ops@corp.com", "buyer_group@corp.com"],
      "summary": "价格预警周报"
    },
    "sink": {
      "toTable": "dw.cmp_vendor_vs_baseline_q1",
      "partitionBy": ["ym"]
    }
  },

  "meta": {
    "createdBy": "buyer_admin",
    "createdAt": "2025-08-12T10:30:00+08:00",
    "versionNote": "Q1集团范围监控；启用b1历史、b2市场"
  }
}
```

**契约与校验提示（研发关注）：**

* `selection.compareIndicatorId` 必须属于模型主数据原子指标；
* `selection.baselineAliases` 必须是模型已声明的别名集合子集；
* `selection.calculatedIndicators[]` 必须是模型已发布且 `enable=true` 的计算指标；
* 物化列命名：

  * 计算指标 `mode=ALL` → 方案勾选后自动加入 `{id}_{alias}`；
  * 若模型对“基准价”本身也注册了最终列名，则可直接出现在 `output.indicators`；
* 规则字段校验：所选规则包用到的字段必须能由本方案产出（维度/指标/score/warn\_flag）；
* 范围与基准继承：`extraFilters` 可按模型白名单映射到基准数据集；
* 空基准策略：`onMissingBaseline` 控制 LEFT JOIN 后的 Null 行处理；
* 排序/格式/导出遵循模型里的类型与单位。

---
