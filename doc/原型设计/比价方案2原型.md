# B. 比价方案2（Scheme）

## 1) Plaintext 原型（最终）

```
页头
────────────────────────────────
比价方案 · 新建/编辑
状态：草稿 | 保存 | 预览 | 启用 | 返回
────────────────────────────────

(1) 基本信息
- 方案名称*        [同品多商-集团协议价对比]
- 方案编码*        [cmp_vendor_price_001]
- 标签            [集团采购] [价格监控]
- 描述            [_________________________________]
- 启用            (✓)

(2) 绑定比价模型*
- 已选模型：      [ mdl_vendor_compare ▼ ]
- 只读概览：      对象键/分析对象/维度/可用分析指标/基准候选/显示属性

(3) 查询范围（WHERE 条件）
- 组织范围        [ 集团 ] [ 子公司A ] [+]（树勾选）
- 商品范围        分类[ IVD试剂 ▼ ]  品牌[ Roche ▼ ]  [SKU清单导入]
- 时间范围*       [ 2024-01-01 ~ 2024-12-31 ]（根据模型主表时间字段）
- 供应商（可选）  [ 多选下拉/搜索 ]
- 其他条件模板     [ + 添加 ]（字段=值/IN/LIKE/区间）

(4) 基准选择（可多基准并列）
- 对比侧指标*     [ ind_agreement_price ▼ ]      // 来自模型 analysisIndicators（主数据集）
- 基准1：         数据集= [ h ]  指标= [ lib.hist_min ▼ ]  别名= [b1] 
  查询条件（可选，覆盖/追加于(3)）： [ h.tx_date >= '2023-01-01' ]
- 基准2：         数据集= [ m ]  指标= [ lib.market_ref ▼ ] 别名= [b2]
- 基准3：         数据集= [ b ]  指标= [ lib.bid_min ▼ ]    别名= [b3]
[ + 添加基准 ]

(5) 计算指标（在方案层定义，绑定 ${COMPARE} / ${BASELINE}）
- [ + 新建计算指标模板 ]
  · 指标ID*        [ ind_diff_rate_b1 ]
  · 名称*          [ 与历史最低差异率 ]
  · 公式*          [ ( ${COMPARE} - ${BASELINE} ) / ${BASELINE} ]
  · 绑定基准*      [ b1 ]     // 将 ${BASELINE} → b1 对应指标；${COMPARE} → 对比侧
  · 单位           [ percent ]

- [ + 新建计算指标模板 ]
  · 指标ID*        [ ind_diff_amount_b2 ]
  · 名称*          [ 与市场参考差额 ]
  · 公式*          [ ${COMPARE} - ${BASELINE} ]
  · 绑定基准*      [ b2 ]
  · 单位           [ CNY ]

(6) 规则与输出
- 规则集（可选）   [ rule_vendor_compare_default ▼ ]（控制型/评分型）
- 输出列（可覆盖模型默认）
  维度列：         [ 供应商 ] [ 采购组织 ]
  指标列：         [ 协议价 ] [ 历史最低价(b1) ] [ 市场参考价(b2) ] [ 差异率_b1 ] [ 差额_b2 ] [ 评分 ]
- 排序：           [ 差异率_b1 ↓ ]  次序 [ 评分 ↓ ]
- 颜色/标记（可选）   [ ind_diff_rate_b1 > 0.1 → 标红 ]
- 导出格式          [ Excel ] [ CSV ] [ API ]

(7) 预览与执行
- 生成 SQL & 试跑样例 → 规则命中/评分预览 → 保存/启用
```

## 2) UI 原型（草图）

```
┌────────────────────────────────────────────────────────────┐
│ 步骤条：①基本 → ②绑定模型 → ③查询范围 → ④基准选择 → ⑤计算指标 → ⑥规则/输出 → ⑦预览 │
├────────────────────────────────────────────────────────────┤
│ ④基准卡片：每个基准一张卡（数据集别名+指标+别名+条件按钮）  [添加基准]              │
│ ⑤计算指标：列表 + 右侧编辑器（公式=表达式编辑，绑定基准下拉）                          │
│ ⑥输出：维度/指标拖拽到“已选列”，排序/颜色规则，选择规则集                                 │
└────────────────────────────────────────────────────────────┘
```

## 3) 界面配置 JSON（示例）

```json
{
  "schemeName": "同品多商-集团协议价对比",
  "schemeCode": "cmp_vendor_price_001",
  "tags": ["集团采购", "价格监控"],
  "enabled": true,

  "modelRef": { "id": "mdl_vendor_compare", "name": "通用同品多商比价模型" },

  "scope": {
    "org": ["集团", "子公司A"],
    "product": { "category": "IVD试剂", "brand": "Roche", "skuList": null },
    "vendor": null,
    "timeRange": ["2024-01-01", "2024-12-31"],
    "extraFilters": [
      { "field": "a.purchase_mode", "op": "IN", "value": ["集中"] }
    ]
  },

  "compareIndicator": {
    "id": "ind_agreement_price",
    "name": "协议价",
    "datasetAlias": "a"
  },

  "baselines": [
    {
      "alias": "b1",
      "datasetAlias": "h",
      "indicatorLibId": "lib.hist_min",
      "name": "历史最低价",
      "conditions": ["h.tx_date >= '2023-01-01'"]
    },
    {
      "alias": "b2",
      "datasetAlias": "m",
      "indicatorLibId": "lib.market_ref",
      "name": "市场参考价",
      "conditions": []
    },
    {
      "alias": "b3",
      "datasetAlias": "b",
      "indicatorLibId": "lib.bid_min",
      "name": "中标最低价",
      "conditions": []
    }
  ],

  "computedIndicators": [
    {
      "id": "ind_diff_rate_b1",
      "name": "与历史最低差异率",
      "formula": "( ${COMPARE} - ${BASELINE} ) / ${BASELINE}",
      "bindBaselineAlias": "b1",
      "unit": "percent"
    },
    {
      "id": "ind_diff_amount_b2",
      "name": "与市场参考差额",
      "formula": "${COMPARE} - ${BASELINE}",
      "bindBaselineAlias": "b2",
      "unit": "CNY"
    }
  ],

  "ruleSetRef": { "id": "rule_vendor_compare_default", "name": "默认供应商比价规则集" },

  "output": {
    "columns": [
      "a.vendor_id",
      "a.purchase_org",
      "ind_agreement_price",
      "b1.lib.hist_min as hist_min",
      "b2.lib.market_ref as market_ref",
      "ind_diff_rate_b1",
      "ind_diff_amount_b2",
      "score"
    ],
    "orderBy": [
      { "field": "ind_diff_rate_b1", "order": "desc" },
      { "field": "score", "order": "desc" }
    ],
    "styleRules": [
      { "expr": "ind_diff_rate_b1 > 0.10", "style": {"color":"red"} }
    ],
    "export": ["excel", "csv", "api"]
  }
}
```

---

## 说明要点（保证可落地）

* **规则集独立**：表达式中使用的字段/指标由方案执行期传入（方案 SQL 产出的列），因此规则可复用到不同方案。
* **多基准并列**：`baselines[]` 支持多个基准，`computedIndicators[]` 通过 `bindBaselineAlias` 把 `${BASELINE}` 绑定到某一基准，`${COMPARE}` 自动指向对比侧指标。
* **范围 & 条件**：方案有全局范围 `(scope)`；每个基准可有**追加条件**（如历史期限制），两者在引擎里**合并**生成 SQL。
* **输出控制**：方案层可覆盖模型默认输出；支持列拖拽、排序、样式规则（着色/标记）。
* **契约清晰**：模型→方案→规则，三者 JSON 结构边界明确，方便前后端对接与引擎实现。

---