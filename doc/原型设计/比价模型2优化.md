好嘞！下面给你一套可直接给设计/前端落地的规格：**plaintext 原型 + UI 原型描述 + 配置 JSON（含校验规则）+ 推荐交互组件**。场景是“在**比价模型**里定义计算指标”，方案只勾选使用，规则直接引用模型里的原子/基准/计算指标。

# 一、Plaintext 原型（信息架构 / 字段项）

```
[弹窗] 编辑计算指标
路径：比价模型 → 指标 → 计算指标 → 新增/编辑

1) 基本信息
- 指标ID*            [ind_diff_rate] （英文+下划线，唯一）
- 名称*              [差异率]
- 描述               [协议价相对基准价的差异比例]
- 标签               [价格对比] [监控] [+]

2) 绑定范围
- 绑定基准*          [ 全部基准 | 指定基准 ]
  · 当=指定基准 → 基准别名*  [b1 | b2 | ...]  (来自模型中已配置的基准数据集 alias)
- 参与侧指标*        [ 从主数据集原子指标选择：协议价/含税价/... ]
- 基准侧指标*        [ 从基准候选选择：历史最低/市场参考/中标最低/... ]

3) 公式编辑
- 计算方式           [ 可视化编辑 | 高级表达式 ]
  · 可视化编辑（默认）：
      ( [参与侧指标▼]  -  [基准侧指标▼] )  ÷  [基准侧指标▼]
      [插入变量]：参与侧指标、基准侧指标
      [插入函数]：差异额、差异率、百分比变化、四舍五入、NULL 处理
  · 高级表达式（可选，带语法高亮、校验）：
      ( ${COMPARE} - ${BASELINE} ) / NULLIF(${BASELINE},0)

- 可用变量（只读说明）：
    ${COMPARE} 代表选择的参与侧指标
    ${BASELINE}代表选择的基准侧指标（按“绑定基准/别名”替换）

4) 类型与格式
- 数据类型*          [ number ]
- 单位               [ % | CNY | 其他 ]
- 小数位             [ 0~6 ]
- 展示格式           [ 百分比 | 货币 | 千分位 ]

5) 安全与兜底
- 空值/除0处理       [ 当 BASELINE=0 → 返回 NULL | 返回 0 | 自定义 ]
- 负值裁剪           [ 不裁剪 | 下限0 | 区间 0~1 ]
- 异常标记           [ 结果为 NULL/INF 时标记 calc_error=true ]

6) 实时预览
- 当前模式：全部基准 / 指定基准（b1）
- 替换后公式示例（多基准时按行列出）：
    (price_contract - price_hist_min) / NULLIF(price_hist_min,0)
    (price_contract - price_market_ref) / NULLIF(price_market_ref,0)
- 样例取数：选择时间/组织（继承模型白名单）→ [试跑] → 显示前50行

7) 版本与启用
- 启用开关          [ 开 | 关 ]
- 版本注释          [ 初始版本 / 修改除0处理为NULLIF / ... ]

[取消] [保存]
```

# 二、UI 原型（结构与交互）

**布局：** 右侧抽屉 / 居中弹窗都可。两栏：左表单 + 右预览。

* **字段控件与交互**

  * 指标ID/名称/描述：`TextField`
  * 标签：`Tag/Chips + Autocomplete`
  * 绑定基准：`Segmented Control`（全部基准 | 指定基准）

    * 当选“指定基准”→ 显示 `Select[基准别名]`
  * 参与侧指标：`Select`（来源=主数据集原子指标）
  * 基准侧指标：`Select`（来源=基准候选原子指标，可随别名过滤）
  * 公式编辑：

    * 默认 **可视化构造器**：三个 `Select` 拼接 + `IconButton`（+、-、÷、×）
    * 「插入变量」面板：`ButtonGroup`（参与侧指标、基准侧指标）
    * 「插入函数」面板：`Dropdown/Popover`（差异额、差异率、百分比变化、四舍五入、NULL处理 等）
    * 高级表达式：`MonacoEditor`（语法高亮、括号匹配、占位符自动补全）
  * 类型与格式：`Select`（数据类型/单位/展示格式）+ `NumberInput`（小数位）
  * 安全与兜底：`RadioGroup`（除0策略）+ `Switch/Slider`（裁剪）+ `Checkbox`（异常标记）
  * 实时预览：`CodeBlock`（SQL 片段）+ `Table`（样例预览）
  * 启用开关：`Switch`
  * 版本注释：`TextArea`
  * 底部：`Primary Button: 保存`、`Default Button: 取消`

**关键交互：**

* 切换 **全部基准/指定基准**：

  * 全部基准 → 预览区展示多行替换结果，并展示最终会生成的列名（如 `ind_diff_rate_b1/b2/...`）
  * 指定基准 → 露出「基准别名」必选，预览仅一行
* 选择 参与侧/基准侧 指标时，**变量提示条**同步显示：

  * `${COMPARE} = 协议价`、`${BASELINE} = 历史最低价(b1)`
* 可视化编辑构造出公式后，可一键切换到高级表达式查看“占位符版本”；切回时保持等价。
* 保存前校验失败禁用“保存”，错误项高亮并定位到对应表单项。

# 三、配置 JSON（落地契约 / 校验规则）

**单个计算指标的模型配置：**

```json
{
  "modelId": "mdl_vendor_compare",
  "calcIndicator": {
    "id": "ind_diff_rate",
    "name": "差异率",
    "description": "协议价相对基准价的差异比例",
    "tags": ["价格对比", "监控"],
    "binding": {
      "mode": "ALL",                       // ALL | ALIAS
      "alias": null                        // mode=ALIAS 时必填，如 "b1"
    },
    "sources": {
      "compareIndicatorId": "ind_agreement_price", // 参与侧原子指标ID（主数据集）
      "baselineIndicatorId": "ind_hist_min"        // 基准侧原子指标ID（用于预览/校验）
    },
    "formula": {
      "mode": "visual",                    // visual | advanced
      "expr": "( ${COMPARE} - ${BASELINE} ) / NULLIF(${BASELINE},0)",
      "functions": ["DIFF_RATE","NULLIF"], // 可选：记录使用到的函数
      "placeholders": {                    // 保存时由UI自动生成
        "COMPARE": "ind_agreement_price",
        "BASELINE": "ind_hist_min"
      }
    },
    "type": "number",
    "unit": "percent",                     // percent | CNY | none | custom
    "decimals": 4,
    "format": "percentage",                // percentage | currency | thousand
    "safety": {
      "divideByZero": "NULL",              // NULL | ZERO | CUSTOM
      "clip": { "enabled": false, "min": 0, "max": 1 },
      "markOnAnomaly": true                // 结果为NULL/INF时打标
    },
    "enable": true,
    "versionNote": "初始版本"
  }
}
```

**保存校验规则（要点）：**

* `id`：`^[a-z][a-z0-9_]{2,50}$` 且在 `modelId` 范围内唯一。
* `binding.mode=ALL` → 保存时为每个基准 alias 生成列名映射：`{id}_{alias}`；`mode=ALIAS` → 需要 `binding.alias`。
* `sources.compareIndicatorId` 必须来自主数据集原子指标池；`baselineIndicatorId` 必须来自基准候选池。
* `formula`：

  * visual/advanced 二选一；advanced 必须出现 `${COMPARE}` 与 `${BASELINE}`（若选择了绑定基准）。
  * 变量/函数白名单校验；禁止任意 SQL。
  * 循环依赖检测：计算指标不能互相引用成环。
* 类型/单位/格式：与规则/报表引擎支持的枚举一致。
* `safety.divideByZero` 生效时，运行时自动把 `x / 0` 转换为约定行为（如 `NULLIF(...)`）。

**运行期展开（引擎约定）：**

* `mode=ALL` → 物化列：`ind_diff_rate_b1`、`ind_diff_rate_b2`…；
* `mode=ALIAS` → 物化列：`ind_diff_rate`；
* 规则/方案字段选择器直接读取模型注册的**最终列名**（含后缀）。

# 四、推荐交互组件（选型建议）

* **框架**：React + Tailwind；构建器用 `Monaco Editor`（高级表达式）。
* **表单**：`react-hook-form` / `Formik` + `Zod/Yup` 校验。
* **下拉/多选**：`shadcn/ui` 的 `Select`, `Combobox`, `Command`。
* **标签**：`Chips/Badge`（shadcn `Badge` + 可删除）。
* **Segmented Control**：`Tabs`/`Segmented` 切换“全部基准/指定基准”。
* **函数库面板**：`Popover + Command` 搜索函数，点击插入。
* **可视化公式构造**：自定义控件（`Select` + `IconButton` 操作符 + `Token`），输出与高级表达式保持等价。
* **SQL 预览**：`CodeBlock`（Monaco 只读实例，语法高亮）。
* **样例试跑**：点击后走后端 Mock/真实取数接口，`Table` 展示前 50 行。
* **校验反馈**：表单项下方红字 + 右侧“校验状态列表”统一汇总。

# 五、两种“绑定基准”模式差异（给设计/前端的明确约束）

* **全部基准（ALL）**

  * 预览：多行替换结果
  * 产出列：`{id}_{alias}`（如 `ind_diff_rate_b1`）
  * 方案/规则选择字段：显示带后缀的列
* **指定基准（ALIAS）**

  * 预览：单行替换结果
  * 产出列：`{id}`
  * 保存必须校验 `alias` 不为空

---
