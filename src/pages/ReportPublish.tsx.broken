import React, { useState } from 'react';
import {
  Card,
  Button,
  Space,
  Typography,
  Row,
  Col,
  Divider,
  Tag,
  message,
  Empty,
  Layout,
  Collapse,
  Tree,
  Select,
  Tabs,
  Form,
  Input
} from 'antd';
import { useNavigate } from 'react-router-dom';
import {
  SaveOutlined,
  EyeOutlined,
  ClearOutlined,
  DragOutlined,
  PlusOutlined,
  DeleteOutlined,
  CaretRightOutlined,
  CaretDownOutlined,
  DatabaseOutlined,
  AimOutlined,
  CalculatorOutlined,
  FunctionOutlined,
  LineChartOutlined,
  FolderOutlined,
  FolderOpenOutlined,
  ApiOutlined,
  SafetyOutlined,
  TeamOutlined,
  SettingOutlined
} from '@ant-design/icons';
import PermissionManagementDialog from '../components/PermissionManagementDialog';
import MetricConfigDialog from '../components/MetricConfigDialog';
import { SheetComponent } from '@antv/s2-react';
import QueryConditionsPanel, { QueryCondition, FieldMetadata } from '../components/QueryConditionsPanel';
import { EnhancedDroppedItem } from '../types/metric';
import dayjs from 'dayjs';

const { Title, Text } = Typography;
const { Content } = Layout;
const { TextArea } = Input;

interface ReportItem {
  id: string;
  name: string;
  type: 'comparison' | 'dimension' | 'metric' | 'calculated' | 'baseline';
  category?: string;
  description?: string;
}

// ä½¿ç”¨æ‰©å±•çš„ DroppedItem ç±»å‹
type DroppedItem = EnhancedDroppedItem;

const ReportPublish: React.FC = () => {
  const navigate = useNavigate();
  const [form] = Form.useForm();
  const [selectedScheme, setSelectedScheme] = useState<string>('');
  const [selectedReportGroup, setSelectedReportGroup] = useState<string>('');
  const [droppedItems, setDroppedItems] = useState<DroppedItem[]>([]);
  const [draggedItem, setDraggedItem] = useState<ReportItem | null>(null);
  const [expandedKeys, setExpandedKeys] = useState<string[]>(['dimension', 'metric', 'calculated', 'baseline']);
  const [loading, setLoading] = useState(false);

  // æŠ¥è¡¨åˆ†ç»„ç›¸å…³çŠ¶æ€
  const [reportGroups, setReportGroups] = useState<string[]>([
    'è´¢åŠ¡åˆ†ææŠ¥è¡¨',
    'é‡‡è´­æ¯”ä»·æŠ¥è¡¨',
    'åº“å­˜åˆ†ææŠ¥è¡¨',
    'é”€å”®ä¸šç»©æŠ¥è¡¨'
  ]);
  const [isAddingGroup, setIsAddingGroup] = useState(false);
  const [newGroupName, setNewGroupName] = useState('');

  // æƒé™ç®¡ç†å¯¹è¯æ¡†çŠ¶æ€
  const [permissionDialogOpen, setPermissionDialogOpen] = useState(false);

  // æŒ‡æ ‡é…ç½®å¯¹è¯æ¡†çŠ¶æ€
  const [metricConfigDialogOpen, setMetricConfigDialogOpen] = useState(false);
  const [currentMetricItem, setCurrentMetricItem] = useState<DroppedItem | null>(null);

  // æ¯”ä»·æ–¹æ¡ˆæ•°æ®
  const [schemes] = useState([
    { id: 'scheme_001', name: 'ä½“å¤–è¯Šæ–­è¯•å‰‚æ¯”ä»·æ–¹æ¡ˆ', description: 'é’ˆå¯¹ä½“å¤–è¯Šæ–­è¯•å‰‚çš„ä¸“ä¸šæ¯”ä»·æ–¹æ¡ˆ' },
    { id: 'scheme_002', name: 'åŒ»ç–—è®¾å¤‡æ¯”ä»·æ–¹æ¡ˆ', description: 'å¤§å‹åŒ»ç–—è®¾å¤‡é‡‡è´­æ¯”ä»·åˆ†ææ–¹æ¡ˆ' },
    { id: 'scheme_003', name: 'è¯å“æ¯”ä»·æ–¹æ¡ˆ', description: 'å„ç±»è¯å“ä»·æ ¼å¯¹æ¯”åˆ†ææ–¹æ¡ˆ' },
    { id: 'scheme_004', name: 'è€—ææ¯”ä»·æ–¹æ¡ˆ', description: 'åŒ»ç”¨è€—æä»·æ ¼å¯¹æ¯”æ–¹æ¡ˆ' }
  ]);

  // æŸ¥è¯¢æ¡ä»¶çŠ¶æ€
  const [queryConditions, setQueryConditions] = useState<QueryCondition[]>([]);

  // æ–¹æ¡ˆé€‰æ‹©å˜åŒ–å¤„ç†
  const handleSchemeChange = (schemeId: string) => {
    setSelectedScheme(schemeId);
    const selectedSchemeData = schemes.find(scheme => scheme.id === schemeId);
    if (selectedSchemeData) {
      // è‡ªåŠ¨ç”ŸæˆæŠ¥è¡¨åç§°
      const currentDate = dayjs().format('YYYYå¹´MMæœˆDDæ—¥');
      const generatedName = `${currentDate}${selectedSchemeData.name}`;
      form.setFieldsValue({ reportName: generatedName });
    }
  };

  // æŠ¥è¡¨åˆ†ç»„é€‰æ‹©å˜åŒ–å¤„ç†
  const handleReportGroupChange = (value: string) => {
    if (value === 'add_new') {
      setIsAddingGroup(true);
      setSelectedReportGroup('');
    } else {
      setSelectedReportGroup(value);
      setIsAddingGroup(false);
    }
  };

  // æ·»åŠ æ–°æŠ¥è¡¨åˆ†ç»„
  const handleAddNewGroup = () => {
    if (!newGroupName.trim()) {
      message.warning('è¯·è¾“å…¥åˆ†ç»„åç§°');
      return;
    }

    if (reportGroups.includes(newGroupName.trim())) {
      message.warning('è¯¥åˆ†ç»„å·²å­˜åœ¨');
      return;
    }

    const updatedGroups = [...reportGroups, newGroupName.trim()];
    setReportGroups(updatedGroups);
    setSelectedReportGroup(newGroupName.trim());
    setNewGroupName('');
    setIsAddingGroup(false);
    message.success('æ·»åŠ åˆ†ç»„æˆåŠŸ');
  };

  // å–æ¶ˆæ·»åŠ åˆ†ç»„
  const handleCancelAddGroup = () => {
    setNewGroupName('');
    setIsAddingGroup(false);
    setSelectedReportGroup('');
  };

  // æƒé™ç®¡ç†ç›¸å…³å‡½æ•°
  const handleOpenPermissionDialog = () => {
    setPermissionDialogOpen(true);
  };

  const handleClosePermissionDialog = () => {
    setPermissionDialogOpen(false);
  };

  // æŒ‡æ ‡é…ç½®ç›¸å…³å‡½æ•°
  const handleOpenMetricConfigDialog = (item: DroppedItem) => {
    setCurrentMetricItem(item);
    setMetricConfigDialogOpen(true);
  };

  const handleCloseMetricConfigDialog = () => {
    setMetricConfigDialogOpen(false);
    setCurrentMetricItem(null);
  };

  const handleSaveMetricConfig = (config: any) => {
    if (currentMetricItem) {
      setDroppedItems(prev =>
        prev.map(item =>
          item.id === currentMetricItem.id
            ? { ...item, metricConfig: config }
            : item
        )
      );
      message.success('æŒ‡æ ‡é…ç½®å·²ä¿å­˜');
    }
  };

  const handleSavePermissions = (permissions: any[]) => {
    console.log('ä¿å­˜æƒé™é…ç½®:', permissions);
    // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„ä¿å­˜é€»è¾‘
  };

  // å›ºå®šç»´åº¦ - æ¯”å¯¹å¯¹è±¡ç›¸å…³ç»´åº¦
  const fixedComparisonDimensions: ReportItem[] = [
    { id: 'comp-sku', name: 'SKUç¼–ç ', type: 'dimension', description: 'äº§å“SKUç¼–ç ' },
    { id: 'comp-name', name: 'äº§å“åç§°', type: 'dimension', description: 'äº§å“å…·ä½“åç§°' },
    { id: 'comp-category', name: 'äº§å“ç±»åˆ«', type: 'dimension', description: 'äº§å“åˆ†ç±»' }
  ];

  // Mockæ•°æ® - æ¯”å¯¹ç»´åº¦
  const mockDimensions: ReportItem[] = [
    { id: 'dim1', name: 'äº§å“åç§°', type: 'dimension', description: 'æ£€æµ‹äº§å“çš„å…·ä½“åç§°' },
    { id: 'dim2', name: 'è§„æ ¼å‹å·', type: 'dimension', description: 'äº§å“çš„è§„æ ¼å‚æ•°' },
    { id: 'dim3', name: 'ç”Ÿäº§å‚å®¶', type: 'dimension', description: 'äº§å“ç”Ÿäº§å‚å•†' },
    { id: 'dim4', name: 'çœä»½', type: 'dimension', description: 'é”€å”®åŒºåŸŸçœä»½' },
    { id: 'dim5', name: 'åŒ»é™¢ç­‰çº§', type: 'dimension', description: 'åŒ»ç–—æœºæ„ç­‰çº§åˆ†ç±»' }
  ];

  // Mockæ•°æ® - æ¯”å¯¹æŒ‡æ ‡
  const mockMetrics: ReportItem[] = [
    { id: 'met1', name: 'ä¸­æ ‡ä»·æ ¼', type: 'metric', description: 'äº§å“ä¸­æ ‡ä»·æ ¼' },
    { id: 'met2', name: 'æŒ‚ç½‘ä»·æ ¼', type: 'metric', description: 'å¹³å°æŒ‚ç½‘ä»·æ ¼' },
    { id: 'met3', name: 'é‡‡è´­é‡', type: 'metric', description: 'é‡‡è´­æ•°é‡ç»Ÿè®¡' },
    { id: 'met4', name: 'é‡‡è´­é‡‘é¢', type: 'metric', description: 'é‡‡è´­æ€»é‡‘é¢' }
  ];

  // Mockæ•°æ® - è®¡ç®—æŒ‡æ ‡
  const mockCalculatedMetrics: ReportItem[] = [
    { id: 'calc1', name: 'ä»·å·®ç‡', type: 'calculated', description: '(ä¸­æ ‡ä»·æ ¼-æŒ‚ç½‘ä»·æ ¼)/æŒ‚ç½‘ä»·æ ¼' },
    { id: 'calc2', name: 'å¸‚åœºä»½é¢', type: 'calculated', description: 'ä¼ä¸šé‡‡è´­é‡å æ¯”' },
    { id: 'calc3', name: 'ä»·æ ¼æ’å', type: 'calculated', description: 'æŒ‰ä»·æ ¼ä»ä½åˆ°é«˜æ’å' }
  ];

  // Mockæ•°æ® - åŸºå‡†æŒ‡æ ‡
  const mockBaselineMetrics: ReportItem[] = [
    { id: 'base1', name: 'å¹³å‡ä»·æ ¼', type: 'baseline', description: 'æ‰€æœ‰ä¼ä¸šå¹³å‡ä¸­æ ‡ä»·æ ¼' },
    { id: 'base2', name: 'æœ€ä½ä»·æ ¼', type: 'baseline', description: 'æ‰€æœ‰ä¼ä¸šæœ€ä½ä¸­æ ‡ä»·æ ¼' },
    { id: 'base3', name: 'å¸‚åœºåŸºå‡†ä»·', type: 'baseline', description: 'è¡Œä¸šå¸‚åœºåŸºå‡†ä»·æ ¼' },
    { id: 'base4', name: 'å†å²å‡ä»·', type: 'baseline', description: 'å†å²é‡‡è´­å¹³å‡ä»·æ ¼' }
  ];

  // å¯ç”¨å­—æ®µå…ƒæ•°æ®ï¼ˆç”¨äºæŸ¥è¯¢æ¡ä»¶ï¼‰
  const availableFields: FieldMetadata[] = [
    // ç»´åº¦å­—æ®µ
    { id: 'dim1', name: 'äº§å“åç§°', type: 'dimension', componentType: 'input', description: 'æ£€æµ‹äº§å“çš„å…·ä½“åç§°' },
    { id: 'dim2', name: 'è§„æ ¼å‹å·', type: 'dimension', componentType: 'select', options: ['Aå‹', 'Bå‹', 'Cå‹'], description: 'äº§å“çš„è§„æ ¼å‚æ•°' },
    { id: 'dim3', name: 'ç”Ÿäº§å‚å®¶', type: 'dimension', componentType: 'multiSelect', options: ['å‚å®¶A', 'å‚å®¶B', 'å‚å®¶C'], description: 'äº§å“ç”Ÿäº§å‚å•†' },
    { id: 'dim4', name: 'çœä»½', type: 'dimension', componentType: 'select', options: ['åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿ä¸œ', 'æ±Ÿè‹'], description: 'é”€å”®åŒºåŸŸçœä»½' },
    { id: 'dim5', name: 'åŒ»é™¢ç­‰çº§', type: 'dimension', componentType: 'select', options: ['ä¸‰ç”²', 'ä¸‰ä¹™', 'äºŒç”²'], description: 'åŒ»ç–—æœºæ„ç­‰çº§åˆ†ç±»' },
    { id: 'dim6', name: 'é‡‡è´­æ—¥æœŸ', type: 'dimension', componentType: 'dateRangePicker', description: 'é‡‡è´­æ—¥æœŸèŒƒå›´' },
    { id: 'dim7', name: 'ç»„ç»‡æœºæ„', type: 'dimension', componentType: 'modalSelector', description: 'é€‰æ‹©ç»„ç»‡æœºæ„' },

    // æŒ‡æ ‡å­—æ®µ
    { id: 'met1', name: 'ä¸­æ ‡ä»·æ ¼', type: 'metric', componentType: 'numberRange', description: 'äº§å“ä¸­æ ‡ä»·æ ¼' },
    { id: 'met2', name: 'æŒ‚ç½‘ä»·æ ¼', type: 'metric', componentType: 'numberRange', description: 'å¹³å°æŒ‚ç½‘ä»·æ ¼' },
    { id: 'met3', name: 'é‡‡è´­é‡', type: 'metric', componentType: 'numberRange', description: 'é‡‡è´­æ•°é‡ç»Ÿè®¡' },
    { id: 'met4', name: 'é‡‡è´­é‡‘é¢', type: 'metric', componentType: 'numberRange', description: 'é‡‡è´­æ€»é‡‘é¢' }
  ];

  // é¢„ç½®æŸ¥è¯¢æ¡ä»¶ï¼ˆä»æ¯”ä»·æ–¹æ¡ˆé…ç½®ä¸­è·å–ï¼‰
  const predefinedConditions: QueryCondition[] = [
    {
      id: 'predefined-1',
      fieldId: 'dim5',
      fieldName: 'åŒ»é™¢ç­‰çº§',
      fieldType: 'dimension',
      groupType: 'comparison',
      value: ['ä¸‰ç”²'],
      isPredefined: true,
      componentType: 'multiSelect'
    },
    {
      id: 'predefined-2',
      fieldId: 'met1',
      fieldName: 'ä¸­æ ‡ä»·æ ¼',
      fieldType: 'metric',
      groupType: 'metric',
      value: { min: 100, max: 10000 },
      isPredefined: true,
      componentType: 'numberRange'
    },
    {
      id: 'predefined-3',
      fieldId: 'dim2',
      fieldName: 'è§„æ ¼å‹å·',
      fieldType: 'dimension',
      groupType: 'baseline',
      value: 'Aå‹',
      isPredefined: true,
      componentType: 'select',
      baselineName: 'é›†å›¢ä»·'
    },
    {
      id: 'predefined-4',
      fieldId: 'dim3',
      fieldName: 'ç”Ÿäº§å‚å®¶',
      fieldType: 'dimension',
      groupType: 'baseline',
      value: ['å‚å®¶A', 'å‚å®¶B'],
      isPredefined: true,
      componentType: 'multiSelect',
      baselineName: 'é›†å›¢ä»·'
    },
    {
      id: 'predefined-5',
      fieldId: 'dim6',
      fieldName: 'é‡‡è´­æ—¥æœŸ',
      fieldType: 'dimension',
      groupType: 'baseline',
      value: null,
      isPredefined: true,
      componentType: 'dateRangePicker',
      baselineName: 'å†å²ä»·'
    },
    {
      id: 'predefined-6',
      fieldId: 'dim4',
      fieldName: 'çœä»½',
      fieldType: 'dimension',
      groupType: 'baseline',
      value: ['åŒ—äº¬', 'ä¸Šæµ·'],
      isPredefined: true,
      componentType: 'multiSelect',
      baselineName: 'å†å²ä»·'
    }
  ];

  // åŸºå‡†å¯¹è±¡å›ºå®šåˆ†ç»„é…ç½®
  const baselineGroupConfig = [
    {
      key: 'groupPrice',
      name: 'é›†å›¢ä»·',
      description: 'é›†å›¢é‡‡è´­ä»·æ ¼åŸºå‡†æ¡ä»¶'
    },
    {
      key: 'historyPrice',
      name: 'å†å²ä»·',
      description: 'å†å²é‡‡è´­ä»·æ ¼åŸºå‡†æ¡ä»¶'
    }
  ];

  // æ ‘å‹æ•°æ®ç»“æ„
  const treeData = [
    {
      key: 'dimension',
      title: 'æ¯”å¯¹ç»´åº¦',
      children: mockDimensions.map(item => ({
        key: item.id,
        title: item.name,
        isLeaf: true,
        itemData: item
      }))
    },
    {
      key: 'metric',
      title: 'æ¯”å¯¹æŒ‡æ ‡',
      children: mockMetrics.map(item => ({
        key: item.id,
        title: item.name,
        isLeaf: true,
        itemData: item
      }))
    },
    {
      key: 'calculated',
      title: 'è®¡ç®—æŒ‡æ ‡',
      children: mockCalculatedMetrics.map(item => ({
        key: item.id,
        title: item.name,
        isLeaf: true,
        itemData: item
      }))
    },
    {
      key: 'baseline',
      title: 'åŸºå‡†æŒ‡æ ‡',
      children: mockBaselineMetrics.map(item => ({
        key: item.id,
        title: item.name,
        isLeaf: true,
        itemData: item
      }))
    }
  ];

  // è·å–å¯æ‹–æ‹½é¡¹åˆ—è¡¨
  const getAvailableItems = (): ReportItem[] => {
    return [
      ...mockDimensions,
      ...mockMetrics,
      ...mockCalculatedMetrics,
      ...mockBaselineMetrics
    ];
  };

  // è·å–å·²ä½¿ç”¨çš„é¡¹
  const getUsedItemIds = (): string[] => {
    return droppedItems.map(item => item.id);
  };

  // å¤„ç†æ‹–æ‹½å¼€å§‹
  const handleDragStart = (e: React.DragEvent, item: ReportItem) => {
    if (getUsedItemIds().includes(item.id)) {
      e.preventDefault();
      return;
    }
    setDraggedItem(item);
    e.dataTransfer.effectAllowed = 'copy';
  };

  // è‡ªå®šä¹‰æ ‘èŠ‚ç‚¹æ¸²æŸ“
  const renderTreeNode = (nodeData: any) => {
    const usedItemIds = getUsedItemIds();
    const isUsed = nodeData.itemData && usedItemIds.includes(nodeData.itemData.id);
    const isLeaf = nodeData.isLeaf;

    return (
      <div
        className={`flex items-center h-6 px-2 rounded cursor-pointer transition-all
          ${isUsed ? 'opacity-50 cursor-not-allowed' : 'hover:bg-blue-50'}
        `}
        draggable={isLeaf && !isUsed}
        onDragStart={(e) => {
          if (isLeaf && nodeData.itemData) {
            handleDragStart(e, nodeData.itemData);
          } else {
            e.preventDefault();
          }
        }}
        onDragEnd={handleDragEnd}
      >
        <span className={`text-sm ${isUsed ? 'text-gray-400' : 'text-gray-700'}`}>
          {nodeData.title}
        </span>
        {isUsed && (
          <span className="ml-auto text-xs text-gray-400">å·²ä½¿ç”¨</span>
        )}
      </div>
    );
  };

  // å¤„ç†æ‹–æ‹½ç»“æŸ
  const handleDragEnd = () => {
    setDraggedItem(null);
  };

  // å¤„ç†æ‹–æ‹½æ‚¬åœ
  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
  };

  // å¤„ç†æ”¾ç½®
  const handleDrop = (e: React.DragEvent, position: 'row' | 'column' | 'value') => {
    e.preventDefault();
    if (!draggedItem) return;

    const droppedItem: DroppedItem = {
      ...draggedItem,
      position
    };

    setDroppedItems(prev => {
      // ç§»é™¤å·²å­˜åœ¨çš„é¡¹
      const filtered = prev.filter(item => item.id !== draggedItem.id);
      // æ·»åŠ æ–°é¡¹
      return [...filtered, droppedItem];
    });

    setDraggedItem(null);
  };

  // ç§»é™¤é…ç½®é¡¹
  const removeItem = (itemId: string) => {
    setDroppedItems(prev => prev.filter(item => item.id !== itemId));
  };

  // æ¸…ç©ºé…ç½®
  const clearConfig = () => {
    setDroppedItems([]);
  };

  // é¢„è§ˆæŠ¥è¡¨
  const previewReport = () => {
    if (droppedItems.length === 0) {
      message.warning('è¯·å…ˆé…ç½®æŠ¥è¡¨å†…å®¹');
      return;
    }
    message.success('æŠ¥è¡¨é¢„è§ˆåŠŸèƒ½å¼€å‘ä¸­...');
  };

  // ä¿å­˜é…ç½®
  const saveConfig = async () => {
    try {
      // éªŒè¯è¡¨å•
      const values = await form.validateFields();

      if (droppedItems.length === 0) {
        message.warning('è¯·å…ˆé…ç½®æŠ¥è¡¨å†…å®¹');
        return;
      }

      if (!selectedScheme) {
        message.warning('è¯·é€‰æ‹©æ¯”ä»·æ–¹æ¡ˆ');
        return;
      }

      setLoading(true);

      // æ¨¡æ‹Ÿä¿å­˜é€»è¾‘
      setTimeout(() => {
        const reportData = {
          id: `report_${Date.now()}`,
          reportName: values.reportName,
          schemeId: selectedScheme,
          schemeName: schemes.find(s => s.id === selectedScheme)?.name,
          description: values.description,
          config: {
            droppedItems,
            queryConditions
          },
          createTime: dayjs().format('YYYY-MM-DD HH:mm:ss'),
          creator: 'å½“å‰ç”¨æˆ·'
        };

        console.log('ä¿å­˜æŠ¥è¡¨æ•°æ®:', reportData);
        message.success('æŠ¥è¡¨å‘å¸ƒæˆåŠŸï¼');

        // è·³è½¬åˆ°æ¯”ä»·æŠ¥è¡¨é¡µé¢
        setTimeout(() => {
          navigate('/price-comparison-reports');
        }, 1500);

        setLoading(false);
      }, 1500);
    } catch (error) {
      console.error('ä¿å­˜å¤±è´¥:', error);
      setLoading(false);
    }
  };

  // ç”ŸæˆS2é…ç½®æ•°æ®
  const generateS2Data = () => {
    const rowItems = droppedItems.filter(item => item.position === 'row');
    const columnItems = droppedItems.filter(item => item.position === 'column');
    const valueItems = droppedItems.filter(item => item.position === 'value');

    // è¡Œç»´åº¦å§‹ç»ˆåŒ…å«å›ºå®šçš„ç»´åº¦å­—æ®µ
    const allRowItems = [...fixedComparisonDimensions, ...rowItems];

    if (columnItems.length === 0 && valueItems.length === 0) {
      return { data: [], fields: {} };
    }

    // Mockæ•°æ®ç”Ÿæˆ - æ¨¡æ‹Ÿä¸€äº›SKUæ•°æ®
    const mockData = [];
    const mockSKUs = [
      { 'SKUç¼–ç ': 'SKU001', 'äº§å“åç§°': 'ç”ŸåŒ–åˆ†æä»ªA1', 'äº§å“ç±»åˆ«': 'ç”ŸåŒ–è¯•å‰‚' },
      { 'SKUç¼–ç ': 'SKU002', 'äº§å“åç§°': 'åŒ–å­¦å‘å…‰ä»ªB2', 'äº§å“ç±»åˆ«': 'å…ç–«è¯•å‰‚' },
      { 'SKUç¼–ç ': 'SKU003', 'äº§å“åç§°': 'åŸºå› æµ‹åºä»ªC3', 'äº§å“ç±»åˆ«': 'åˆ†å­è¯Šæ–­' },
      { 'SKUç¼–ç ': 'SKU004', 'äº§å“åç§°': 'ç»†èŒé‰´å®šä»ªD4', 'äº§å“ç±»åˆ«': 'å¾®ç”Ÿç‰©æ£€æµ‹' }
    ];

    mockSKUs.forEach(sku => {
      for (let i = 0; i < 2; i++) {
        const row: any = {
          'SKUç¼–ç ': sku['SKUç¼–ç '],
          'äº§å“åç§°': sku['äº§å“åç§°'],
          'äº§å“ç±»åˆ«': sku['äº§å“ç±»åˆ«']
        };

        rowItems.forEach(item => {
          row[item.name] = `${item.name}_${i + 1}`;
        });

        columnItems.forEach(item => {
          row[item.name] = `${item.name}_ç±»åˆ«${(i % 3) + 1}`;
        });

        valueItems.forEach(item => {
          if (item.type === 'metric') {
            row[item.name] = Math.floor(Math.random() * 10000) / 100;
          } else if (item.type === 'calculated') {
            row[item.name] = Math.floor(Math.random() * 100);
          } else {
            row[item.name] = `å€¼${i + 1}`;
          }
        });

        mockData.push(row);
      }
    });

    const fields = {
      rows: ['SKUç¼–ç ', 'äº§å“åç§°', 'äº§å“ç±»åˆ«', ...rowItems.map(item => item.name)],
      columns: columnItems.map(item => item.name),
      values: valueItems.map(item => item.name)
    };

    return { data: mockData, fields };
  };

  const { data: s2Data, fields: s2Fields } = generateS2Data();

  const s2Options = {
    width: 800,
    height: 400,
    showSeriesNumber: true,
    interaction: {
      enableCopy: true,
      autoResetSheetStyle: false,
    },
    tooltip: {
      showTooltip: true,
      operation: {
        hiddenColumns: true,
      },
    },
    style: {
      layoutContentType: 'table',
      cellCfg: {
        width: 120,
        height: 32,
      },
      rowCfg: {
        width: 120,
      },
      colCfg: {
        width: 120,
        height: 32,
      },
    },
  };

  // æ¸²æŸ“å­—æ®µé¡¹
  const renderFieldItem = (item: ReportItem, isUsed: boolean = false) => {
    const getTypeIcon = (type: string) => {
      switch (type) {
        case 'comparison': return <DatabaseOutlined className="text-blue-600" />;
        case 'dimension': return <AimOutlined className="text-cyan-600" />;
        case 'metric': return <CalculatorOutlined className="text-indigo-600" />;
        case 'calculated': return <FunctionOutlined className="text-violet-600" />;
        case 'baseline': return <LineChartOutlined className="text-teal-600" />;
        default: return <DragOutlined className="text-gray-400" />;
      }
    };

    return (
      <div
        key={item.id}
        draggable={!isUsed}
        onDragStart={(e) => handleDragStart(e, item)}
        onDragEnd={handleDragEnd}
        className={`group flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer border-b border-gray-100
          ${isUsed ? 'opacity-50 cursor-not-allowed' : 'hover:border-l-2 hover:border-l-blue-500 hover:pl-2'}
          transition-all duration-200 h-10
        `}
      >
        <DragOutlined className="text-gray-400 mr-2 text-xs group-hover:text-blue-500" />
        {getTypeIcon(item.type)}
        <span className="ml-2 text-sm flex-1">{item.name}</span>
        {isUsed && (
          <Tag size="small" color="default">å·²ä½¿ç”¨</Tag>
        )}
      </div>
    );
  };

  // æ¸²æŸ“å­—æ®µç»„
  const renderFieldGroup = (title: string, items: ReportItem[], icon: React.ReactNode, bgColor: string, textColor: string) => {
    const usedItemIds = getUsedItemIds();
    const hasUsedItems = items.some(item => usedItemIds.includes(item.id));

    return (
      <div className="border border-gray-200 rounded-lg mb-2 overflow-hidden">
        <div className={`px-3 py-2 flex items-center justify-between ${bgColor}`}>
          <div className="flex items-center">
            {icon}
            <span className={`ml-2 font-medium text-sm ${textColor}`}>{title}</span>
          </div>
          <span className={`text-xs ${textColor} opacity-75`}>
            {items.filter(item => usedItemIds.includes(item.id)).length}/{items.length}
          </span>
        </div>
        <div className="bg-white">
          {items.map(item => renderFieldItem(item, usedItemIds.includes(item.id)))}
        </div>
      </div>
    );
  };

  // æ¸²æŸ“å·²é…ç½®é¡¹
  const renderDroppedItem = (item: DroppedItem) => {
    const getPositionColor = (position: string) => {
      switch (position) {
        case 'row': return 'blue';
        case 'column': return 'green';
        case 'value': return 'orange';
        default: return 'default';
      }
    };

    const getPositionName = (position: string) => {
      switch (position) {
        case 'row': return 'è¡Œ';
        case 'column': return 'åˆ—';
        case 'value': return 'å€¼';
        default: return '';
      }
    };

    const getTypeIcon = (type: string) => {
      switch (type) {
        case 'comparison': return <DatabaseOutlined className="text-blue-600 text-xs" />;
        case 'dimension': return <AimOutlined className="text-cyan-600 text-xs" />;
        case 'metric': return <CalculatorOutlined className="text-indigo-600 text-xs" />;
        case 'calculated': return <FunctionOutlined className="text-violet-600 text-xs" />;
        case 'baseline': return <LineChartOutlined className="text-teal-600 text-xs" />;
        default: return null;
      }
    };

    return (
      <div
        key={item.id}
        className={`group flex items-center px-3 py-2 bg-white border rounded cursor-move hover:shadow-md transition-all duration-200
          border-gray-200 hover:border-${getPositionColor(item.position)}-300
        `}
      >
        <DragOutlined className="text-gray-400 mr-2 text-xs group-hover:text-blue-500" />
        {getTypeIcon(item.type)}

        {/* æŒ‡æ ‡åç§°åŒºåŸŸ - æ·»åŠ æ‚¬æµ®æ•ˆæœå’Œé…ç½®å›¾æ ‡ */}
        <div
          className="ml-2 text-sm flex-1 flex items-center relative"
          style={{
            position: 'relative',
            padding: '2px',
            borderRadius: '4px',
            transition: 'background-color 0.2s'
          }}
          onMouseEnter={(e) => {
            console.log('ğŸ” DEBUG: onMouseEnter è§¦å‘', {
              itemName: item.name,
              itemType: item.type,
              hasMetricConfig: !!item.metricConfig
            });
            e.currentTarget.style.backgroundColor = '#f0f9ff';
            const configIcon = e.currentTarget.querySelector('.config-icon');
            if (configIcon) {
              console.log('ğŸ” DEBUG: æ‰¾åˆ°é…ç½®å›¾æ ‡ï¼Œè®¾ç½®é€æ˜åº¦');
              (configIcon as HTMLElement).style.opacity = '1';
            } else {
              console.log('ğŸ” DEBUG: æœªæ‰¾åˆ°é…ç½®å›¾æ ‡');
            }
          }}
          onMouseLeave={(e) => {
            console.log('ğŸ” DEBUG: onMouseLeave è§¦å‘', { itemName: item.name });
            e.currentTarget.style.backgroundColor = 'transparent';
            const configIcon = e.currentTarget.querySelector('.config-icon');
            if (configIcon) {
              (configIcon as HTMLElement).style.opacity = '0';
            }
          }}
        >
          <span
            className="cursor-pointer"
            style={{
              transition: 'all 0.2s',
              display: 'inline-block'
            }}
            onMouseEnter={(e) => {
              (e.currentTarget as HTMLElement).style.color = '#2563eb';
              (e.currentTarget as HTMLElement).style.fontWeight = '600';
            }}
            onMouseLeave={(e) => {
              (e.currentTarget as HTMLElement).style.color = '#1f2937';
              (e.currentTarget as HTMLElement).style.fontWeight = 'normal';
            }}
          >
            {item.name}
          </span>

          {/* ä»…æŒ‡æ ‡ç±»å‹æ˜¾ç¤ºé…ç½®å›¾æ ‡ */}
          {(item.type === 'metric' || item.type === 'calculated' || item.type === 'baseline') ? (
            <>
              {console.log('ğŸ” DEBUG: æ¸²æŸ“é…ç½®å›¾æ ‡', { itemName: item.name })}
              <Button
                type="text"
                size="small"
                icon={<SettingOutlined />}
                className="config-icon ml-1"
                style={{
                  opacity: 0,
                  transition: 'all 0.2s',
                  color: item.metricConfig ? '#2563eb' : '#9ca3af',
                  padding: '2px 4px',
                  borderRadius: '4px',
                  fontSize: '12px'
                }}
                onClick={(e) => {
                  console.log('ğŸ” DEBUG: é…ç½®å›¾æ ‡è¢«ç‚¹å‡»', { itemName: item.name });
                  e.stopPropagation();
                  handleOpenMetricConfigDialog(item);
                }}
                onMouseEnter={(e) => {
                  console.log('ğŸ” DEBUG: é…ç½®å›¾æ ‡æ‚¬æµ®', { itemName: item.name });
                  const currentTarget = e.currentTarget as HTMLElement;
                  currentTarget.style.backgroundColor = item.metricConfig ? '#dbeafe' : '#f3f4f6';
                  currentTarget.style.color = '#2563eb';
                }}
                onMouseLeave={(e) => {
                  const currentTarget = e.currentTarget as HTMLElement;
                  currentTarget.style.backgroundColor = 'transparent';
                  currentTarget.style.color = item.metricConfig ? '#2563eb' : '#9ca3af';
                }}
              />
            </>
          ) : (
            <>{console.log('ğŸ” DEBUG: ä¸æ¸²æŸ“é…ç½®å›¾æ ‡', { itemName: item.name, itemType: item.type })}</>
          )}
        </div>

        <Tag size="small" color={getPositionColor(item.position)} className="mr-2">
          {getPositionName(item.position)}
        </Tag>
        <Button
          type="text"
          size="small"
          icon={<DeleteOutlined />}
          className="opacity-0 group-hover:opacity-100 transition-opacity text-red-500 hover:text-red-700 hover:bg-red-50"
          onClick={() => removeItem(item.id)}
        />
      </div>
    );
  };

  // æ¸²æŸ“é…ç½®è¡Œ
  const renderConfigRow = (
    label: string,
    position: 'row' | 'column' | 'value',
    color: string
  ) => {
    const positionItems = droppedItems.filter(item => item.position === position);

    const getColorStyle = (color: string) => {
      switch (color) {
        case 'blue': return { bg: '#e6f7ff', active: '#1890ff', text: '#1890ff' };
        case 'green': return { bg: '#e6f9ee', active: '#52c41a', text: '#52c41a' };
        case 'orange': return { bg: '#fff7e6', active: '#fa8c16', text: '#fa8c16' };
        default: return { bg: '#f5f5f5', active: '#666', text: '#666' };
      }
    };

    const colorStyle = getColorStyle(color);

    // å¯¹äºè¡Œç»´åº¦ï¼Œæ˜¾ç¤ºå›ºå®šçš„ç»´åº¦å­—æ®µ + æ”¯æŒæ‹–æ‹½æ·»åŠ å…¶ä»–ç»´åº¦
    if (position === 'row') {
      const rowItems = droppedItems.filter(item => item.position === 'row');
      const allRowItems = [...fixedComparisonDimensions, ...rowItems];

      return (
        <div
          className="flex items-center px-1 py-2 border-b border-gray-200 hover:bg-gray-50 transition-colors min-h-[36px]"
          style={{ gap: '0' }}
          onDragOver={handleDragOver}
          onDrop={(e) => {
            e.preventDefault();
            if (!draggedItem) return;

            // åªå…è®¸ç»´åº¦ç±»å‹çš„å­—æ®µæ‹–æ‹½åˆ°è¡Œç»´åº¦
            if (draggedItem.type !== 'dimension') {
              message.warning('åªèƒ½å°†ç»´åº¦å­—æ®µæ‹–æ‹½åˆ°è¡Œç»´åº¦');
              return;
            }

            const droppedItem = {
              ...draggedItem,
              position
            };

            setDroppedItems(prev => {
              const filtered = prev.filter(item => item.id !== draggedItem.id);
              return [...filtered, droppedItem];
            });

            setDraggedItem(null);
          }}
        >
          {/* æ ‡ç­¾åŒºåŸŸ - å·¦ä¾§20% */}
          <div className="w-1/5 flex items-center" style={{ paddingRight: '4px' }}>
            <Text className="text-sm text-gray-700">{label}</Text>
          </div>

          {/* æ§ä»¶åŒºåŸŸ - å³ä¾§80% */}
          <div className="w-4/5">
            {allRowItems.length === 0 ? (
              // ä¸‹æ‹‰é€‰æ‹©æ¡†æ ·å¼ï¼ˆå‡çš„ï¼Œåªæ˜¯çœ‹èµ·æ¥åƒä¸‹æ‹‰æ¡†ï¼‰
              <div className="h-6 flex items-center">
                <Select
                  placeholder={`é€‰æ‹©${label}`}
                  className="w-full"
                  style={{
                    fontSize: '14px',
                    margin: 0
                  }}
                  dropdownStyle={{ fontSize: '14px' }}
                  onDropdownVisibleChange={(open) => {
                    if (open) {
                      message.info(`è¯·ä»å·¦ä¾§æ‹–æ‹½å­—æ®µåˆ°${label}`);
                    }
                  }}
                  open={false}
                />
              </div>
            ) : (
              // é€‰é¡¹å¡æ ·å¼ï¼ˆå›ºå®šç»´åº¦ + æ‹–æ‹½ç»´åº¦ï¼‰
              <div className="flex gap-1 items-center h-6">
                {allRowItems.map((item, index) => (
                  <div
                    key={item.id}
                    className={`px-2 py-1 text-xs rounded cursor-pointer transition-all border h-6 flex items-center
                      ${index === 0
                        ? 'bg-blue-100 text-blue-700 border-blue-300'
                        : item.id.startsWith('comp-')
                        ? 'bg-blue-50 text-blue-600 border-blue-200' // å›ºå®šç»´åº¦çš„æ ·å¼
                        : 'bg-gray-100 text-gray-600 border-gray-300 hover:bg-gray-200'
                      }
                    `}
                    onClick={() => {
                      // è¿™é‡Œå¯ä»¥æ·»åŠ é€‰ä¸­é€»è¾‘
                    }}
                  >
                    <div className="flex items-center gap-1">
                      {item.type === 'metric' && (
                        <span className="opacity-75">æ±‚å’Œ</span>
                      )}
                      {item.name}
                    </div>
                    {/* å›ºå®šç»´åº¦ä¸æ˜¾ç¤ºåˆ é™¤æŒ‰é’® */}
                    {!item.id.startsWith('comp-') && (
                      <Button
                        type="text"
                        size="small"
                        icon={<span className="text-gray-400 hover:text-red-500">Ã—</span>}
                        className="ml-1 p-0 h-auto min-w-0 text-xs"
                        onClick={(e) => {
                          e.stopPropagation();
                          setDroppedItems(prev => prev.filter(droppedItem => droppedItem.id !== item.id));
                        }}
                      />
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    }

    return (
      <div
        className="flex items-center px-1 py-2 border-b border-gray-200 hover:bg-gray-50 transition-colors min-h-[36px]"
        style={{ gap: '0' }}
        onDragOver={handleDragOver}
        onDrop={(e) => {
          e.preventDefault();
          if (!draggedItem) return;

          const droppedItem = {
            ...draggedItem,
            position
          };

          setDroppedItems(prev => {
            const filtered = prev.filter(item => item.id !== draggedItem.id);
            return [...filtered, droppedItem];
          });

          setDraggedItem(null);
        }}
      >
        {/* æ ‡ç­¾åŒºåŸŸ - å·¦ä¾§20% */}
        <div className="w-1/5 flex items-center" style={{ paddingRight: '4px' }}>
          <Text className="text-sm text-gray-700">{label}</Text>
        </div>

        {/* æ§ä»¶åŒºåŸŸ - å³ä¾§80% */}
        <div className="w-4/5">
          {positionItems.length === 0 ? (
            // ä¸‹æ‹‰é€‰æ‹©æ¡†æ ·å¼
            <div className="h-6 flex items-center">
              <Select
                placeholder={`é€‰æ‹©${label}`}
                className="w-full"
                style={{
                  fontSize: '14px',
                  margin: 0
                }}
                dropdownStyle={{ fontSize: '14px' }}
                onDropdownVisibleChange={(open) => {
                  if (open) {
                    message.info(`è¯·ä»å·¦ä¾§æ‹–æ‹½å­—æ®µåˆ°${label}`);
                  }
                }}
                open={false}
              />
            </div>
          ) : (
            // é€‰é¡¹å¡æ ·å¼
            <div className="flex gap-1 items-center h-6">
              {positionItems.map((item, index) => (
                <div
                  key={item.id}
                  className={`px-2 py-1 text-xs rounded cursor-pointer transition-all border h-6 flex items-center
                    ${index === 0
                      ? position === 'row'
                        ? 'bg-blue-100 text-blue-700 border-blue-300'
                        : position === 'column'
                        ? 'bg-cyan-100 text-cyan-700 border-cyan-300'
                        : 'bg-indigo-100 text-indigo-700 border-indigo-300'
                      : 'bg-gray-100 text-gray-600 border-gray-300 hover:bg-gray-200'
                    }
                  `}
                  onClick={() => {
                    // è¿™é‡Œå¯ä»¥æ·»åŠ é€‰ä¸­é€»è¾‘
                  }}
                >
                  <div className="flex items-center gap-1">
                    {item.type === 'metric' && (
                      <span className="opacity-75">æ±‚å’Œ</span>
                    )}
                    {item.name}
                  </div>
                  <Button
                    type="text"
                    size="small"
                    icon={<span className="text-gray-400 hover:text-red-500">Ã—</span>}
                    className="ml-1 p-0 h-auto min-w-0 text-xs"
                    onClick={(e) => {
                      e.stopPropagation();
                      removeItem(item.id);
                    }}
                  />
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    );
  };

  const usedItemIds = getUsedItemIds();

  return (
    <Layout className="min-h-screen bg-gray-50">
      <Content className="p-0">
        {/* é¡¶éƒ¨å·¥å…·æ  */}
        <div className="bg-white border-b px-6 py-4">
          <div className="flex items-center justify-between">
            <div>
              <Title level={3} className="mb-2">
                å‘å¸ƒæŠ¥è¡¨
              </Title>
              <Text type="secondary">
                ä»æ¯”ä»·æ–¹æ¡ˆé…ç½®ä¸­æ‹–æ‹½å­—æ®µæ¥åˆ›å»ºè‡ªå®šä¹‰æŠ¥è¡¨å¸ƒå±€
              </Text>
            </div>
            <Space>
              <Button icon={<SafetyOutlined />} onClick={handleOpenPermissionDialog}>
                æƒé™ç®¡ç†
              </Button>
              <Button icon={<EyeOutlined />} onClick={previewReport}>
                é¢„è§ˆæŠ¥è¡¨
              </Button>
              <Button type="primary" icon={<SaveOutlined />} onClick={saveConfig} loading={loading}>
                ä¿å­˜æŠ¥è¡¨
              </Button>
            </Space>
          </div>
        </div>

        <div className="flex">
          {/* å·¦ä¾§é¢æ¿ */}
          <div className="w-80 bg-white border-r h-screen overflow-y-auto">
            <div className="p-4 space-y-4">
              {/* æŠ¥è¡¨åŸºæœ¬ä¿¡æ¯å¡ç‰‡ */}
              <div className="border border-gray-200 rounded-lg">
                <div className="bg-gray-50 px-3 py-2 border-b border-gray-200">
                  <div className="flex items-center">
                    <DatabaseOutlined className="text-blue-600 mr-2" />
                    <span className="font-medium text-sm text-gray-700">æŠ¥è¡¨åŸºæœ¬ä¿¡æ¯</span>
                  </div>
                </div>
                <div className="p-3 space-y-3">
                  <Form form={form} layout="vertical">
                    {/* æŠ¥è¡¨åç§° */}
                    <Form.Item
                      name="reportName"
                      rules={[{ required: true, message: 'è¯·è¾“å…¥æŠ¥è¡¨åç§°' }]}
                      className="mb-3"
                    >
                      <Input
                        placeholder="è¯·è¾“å…¥æŠ¥è¡¨åç§°"
                        style={{ fontSize: '14px' }}
                      />
                    </Form.Item>

                    <Form.Item
                      name="description"
                      className="mb-0"
                    >
                      <TextArea
                        placeholder="è¯·è¾“å…¥æŠ¥è¡¨æè¿°"
                        rows={3}
                        style={{ fontSize: '14px' }}
                      />
                    </Form.Item>
                  </Form>
                </div>

                {/* æ¯”ä»·æ–¹æ¡ˆ */}
                <div className="px-3 pb-3">
                  <div className="text-xs text-gray-600 mb-1">æ¯”ä»·æ–¹æ¡ˆ</div>
                  <Form.Item
                    name="schemeId"
                    rules={[{ required: true, message: 'è¯·é€‰æ‹©æ–¹æ¡ˆ' }]}
                    className="mb-0"
                  >
                    <Select
                      onChange={handleSchemeChange}
                      value={selectedScheme}
                      placeholder="è¯·é€‰æ‹©æ¯”ä»·æ–¹æ¡ˆ"
                      style={{ fontSize: '14px' }}
                    >
                      {schemes.map(scheme => (
                        <Select.Option key={scheme.id} value={scheme.id}>
                          {scheme.name}
                        </Select.Option>
                      ))}
                    </Select>
                  </Form.Item>
                </div>

                {/* æŠ¥è¡¨åˆ†ç»„ */}
                <div className="px-3 pb-3">
                  <div className="text-xs text-gray-600 mb-1">æŠ¥è¡¨åˆ†ç»„</div>
                  {!isAddingGroup ? (
                    <Select
                      value={selectedReportGroup}
                      onChange={handleReportGroupChange}
                      placeholder="é€‰æ‹©åˆ†ç»„"
                      allowClear
                      style={{ fontSize: '14px' }}
                    >
                      {reportGroups.map(group => (
                        <Select.Option key={group} value={group}>
                          {group}
                        </Select.Option>
                      ))}
                      <Select.Option value="add_new" className="text-blue-600">
                        <PlusOutlined className="mr-1" />
                        æ·»åŠ æ–°åˆ†ç»„
                      </Select.Option>
                    </Select>
                  ) : (
                    <div className="flex items-center space-x-1">
                      <Input
                        value={newGroupName}
                        onChange={(e) => setNewGroupName(e.target.value)}
                        placeholder="è¾“å…¥æ–°åˆ†ç»„åç§°"
                        style={{ fontSize: '14px' }}
                        onPressEnter={handleAddNewGroup}
                      />
                      <Button size="small" type="primary" onClick={handleAddNewGroup}>
                        ç¡®å®š
                      </Button>
                      <Button size="small" onClick={handleCancelAddGroup}>
                        å–æ¶ˆ
                      </Button>
                    </div>
                  )}
                </div>
              </div>

              {/* å¯ç”¨å­—æ®µé¢æ¿ */}
              <div>
                <div className="flex items-center justify-between mb-3">
                  <Title level={4} className="mb-0 text-sm">å¯ç”¨å­—æ®µ</Title>
                  <Text type="secondary" className="text-xs">
                    æ‹–æ‹½åˆ°å³ä¾§è¿›è¡Œé…ç½®
                  </Text>
                </div>

                {/* æ ‘å‹æ§ä»¶ */}
                <div className="border border-gray-200 rounded-lg">
                  <Tree
                    showLine={false}
                    showIcon={false}
                    defaultExpandAll={true}
                    expandedKeys={expandedKeys}
                    onExpand={(keys) => setExpandedKeys(keys as string[])}
                    treeData={treeData}
                    titleRender={(nodeData: any) => renderTreeNode(nodeData)}
                    className="field-tree"
                    switcherIcon={({ expanded }) =>
                      expanded ? <CaretDownOutlined className="text-gray-500 text-xs" /> : <CaretRightOutlined className="text-gray-500 text-xs" />
                    }
                  />
                </div>
              </div>
            </div>
          </div>

          {/* å³ä¾§æŠ¥è¡¨é¢„è§ˆåŒºåŸŸ */}
          <div className="flex-1 bg-gray-50">
            {/* æŸ¥è¯¢æ¡ä»¶åŒºåŸŸ */}
            <div className="bg-white">
              <QueryConditionsPanel
                conditions={queryConditions}
                onConditionsChange={setQueryConditions}
                availableFields={availableFields}
                predefinedConditions={predefinedConditions}
              />
            </div>

            {/* æŠ¥è¡¨å¸ƒå±€é…ç½®åŒºåŸŸ */}
            <div className="bg-white border-b">
              <div className="px-3 py-2 border-b border-gray-100">
                <Title level={4} className="mb-0 text-sm">æŠ¥è¡¨å¸ƒå±€é…ç½®</Title>
              </div>

              {/* å‚ç›´é…ç½®è¡Œ */}
              <div className="bg-gray-50">
                {renderConfigRow('è¡Œç»´åº¦', 'row', 'blue')}
                {renderConfigRow('åˆ—ç»´åº¦', 'column', 'green')}
                {renderConfigRow('æŒ‡æ ‡', 'value', 'orange')}
              </div>
            </div>

            {/* æŠ¥è¡¨é¢„è§ˆåŒºåŸŸ */}
            <div className="px-3 py-2">
              <div className="flex items-center justify-between mb-2">
                <Title level={4} className="mb-0 text-sm">æŠ¥è¡¨é¢„è§ˆ</Title>
                <Text type="secondary" className="text-xs">
                  {droppedItems.length > 0
                    ? `å·²é…ç½® ${droppedItems.length} ä¸ªå­—æ®µ`
                    : 'è¯·å…ˆé…ç½®æŠ¥è¡¨å¸ƒå±€'
                  }
                </Text>
              </div>
              <div className="bg-white rounded p-3 shadow-sm">
                {s2Data.length > 0 ? (
                  <div className="overflow-auto">
                    <SheetComponent
                      dataCfg={{
                        data: s2Data,
                        fields: s2Fields,
                        meta: [
                          {
                            field: '*',
                            formatter: (value: any) => {
                              if (typeof value === 'number') {
                                return value.toLocaleString();
                              }
                              return value;
                            },
                          },
                        ],
                      }}
                      options={s2Options}
                    />
                  </div>
                ) : (
                  <div className="text-center py-8">
                    <div className="mb-3">
                      <div className="w-12 h-12 mx-auto rounded-full bg-gray-100 flex items-center justify-center">
                        <DragOutlined className="text-xl text-gray-400" />
                      </div>
                    </div>
                    <Empty
                      image={Empty.PRESENTED_IMAGE_SIMPLE}
                      description="è¯·æ‹–æ‹½å­—æ®µåˆ°ä¸Šæ–¹é…ç½®åŒºåŸŸä»¥ç”ŸæˆæŠ¥è¡¨é¢„è§ˆ"
                    />
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>

        {/* æƒé™ç®¡ç†å¯¹è¯æ¡† */}
        <PermissionManagementDialog
          open={permissionDialogOpen}
          reportId="report_temp_id"
          reportName={form.getFieldValue('reportName') || 'æ–°æŠ¥è¡¨'}
          onClose={handleClosePermissionDialog}
          onSave={handleSavePermissions}
        />

        {/* æŒ‡æ ‡é…ç½®å¯¹è¯æ¡† */}
        {currentMetricItem && (
          <MetricConfigDialog
            open={metricConfigDialogOpen}
            item={{
              id: currentMetricItem.id,
              name: currentMetricItem.name,
              type: currentMetricItem.type as 'metric' | 'calculated' | 'baseline',
              metricConfig: currentMetricItem.metricConfig
            }}
            availableFields={availableFields.filter(field => field.type === 'dimension')}
            onSave={handleSaveMetricConfig}
            onClose={handleCloseMetricConfigDialog}
          />
        )}
      </Content>
    </Layout>
  );
};

export default ReportPublish;